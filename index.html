<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Повітряні тривоги — Україна (відкриті дані)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="color-scheme" content="dark light" />
  <style>
    .pulse-dot{width:10px;height:10px;border-radius:9999px;position:relative;display:inline-block;margin-right:.5rem;background:currentColor}
    .pulse-dot::after{content:"";position:absolute;inset:-6px;border-radius:9999px;border:2px solid currentColor;opacity:.6;animation:pulse 1.5s infinite}
    @keyframes pulse{0%{transform:scale(.6);opacity:.6}70%{transform:scale(1.3);opacity:0}100%{opacity:0}}
    .mono{font-variant-numeric:tabular-nums;font-feature-settings:"tnum"}
  </style>
</head>
<body class="bg-gray-50 text-gray-900 dark:bg-gray-950 dark:text-gray-100">
  <div class="max-w-6xl mx-auto p-4 sm:p-6">
    <header class="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-3 mb-6">
      <div>
        <h1 class="text-2xl sm:text-3xl font-bold">Повітряні тривоги — Україна</h1>
        <p class="text-sm text-gray-500">Відкриті дані без токена • рівень областей • автооновлення кожні 20 секунд</p>
      </div>
      <div class="text-right text-xs text-gray-500">
        Оновлено: <span id="updated" class="mono">—</span><br />
        Часовий пояс: Europe/Kyiv
      </div>
    </header>

    <section class="mb-4">
      <div class="flex flex-wrap gap-2 items-center text-sm">
        <span class="inline-flex items-center rounded-full px-3 py-1 bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-300">
          <span class="pulse-dot" style="color:#ef4444"></span>Активні тривоги
        </span>
        <span class="inline-flex items-center rounded-full px-3 py-1 bg-gray-200 text-gray-700 dark:bg-gray-800 dark:text-gray-300">
          Областей під тривогою: <span id="regionsCount" class="ml-1 font-semibold">0</span>
        </span>
      </div>
      <div class="mt-2 p-3 rounded-xl bg-amber-50 text-amber-900 dark:bg-amber-900/20 dark:text-amber-200 text-xs">
        Перелік міст і громад наразі недоступний з відкритих безключових джерел; відображається рівень областей.
      </div>
    </section>

    <div id="list" class="grid gap-4"></div>

    <footer class="mt-10 text-xs text-gray-500">
      Джерело: https://ubilling.net.ua/aerialalerts/ (без токена). Можна змінити адресу у змінній ENDPOINT.
    </footer>
  </div>

  <script>
    const KYIV_TZ="Europe/Kyiv";
    const POLL_MS=20000;
    const ENDPOINT="https://ubilling.net.ua/aerialalerts/";

    const ADAPTER={
      async load(){
        const r=await fetch(ENDPOINT,{headers:{"Accept":"application/json"},cache:"no-store"});
        if(!r.ok) throw new Error("HTTP "+r.status);
        return r.json();
      },
      parse(json){
        const raw=json&&json.states?json.states:{};
        const out=[];
        if(Array.isArray(raw)){
          for(const s of raw){
            out.push({
              id:s.id??null,
              name:s.name??s.title??"Невідома область",
              alert:Boolean(s.alertnow??s.alert),
              changed:s.changed??s.lastchange??s.date??null
            });
          }
        }else if(typeof raw==="object"&&raw){
          for(const [name,s] of Object.entries(raw)){
            out.push({
              id:s.id??null,
              name:name,
              alert:Boolean(s.alertnow??s.alert),
              changed:s.changed??s.lastchange??s.date??null
            });
          }
        }
        out.sort((a,b)=>a.name.localeCompare(b.name,"uk"));
        return out;
      }
    };

    function fmtTime(s){
      try{
        const d=new Date(s);
        return isNaN(d)?"—":d.toLocaleString("uk-UA",{timeZone:KYIV_TZ,hour12:false});
      }catch{return "—"}
    }

    function render(states){
      const active=states.filter(s=>s.alert);
      active.sort((a,b)=>a.name.localeCompare(b.name,"uk"));
      const container=document.getElementById("list");
      container.innerHTML="";
      if(active.length===0){
        container.innerHTML='<section class="rounded-2xl border border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900 p-4 shadow-sm"><p class="text-sm text-gray-600 dark:text-gray-400">Наразі немає активних повітряних тривог на рівні областей.</p></section>';
      }else{
        for(const s of active){
          const card=document.createElement("section");
          card.className="rounded-2xl border border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900 p-4 shadow-sm";
          const header=document.createElement("div");
          header.className="flex items-start justify-between gap-3";
          header.innerHTML='<div><h2 class="text-lg sm:text-xl font-semibold flex items-center gap-2"><span class="pulse-dot" style="color:#ef4444"></span>'+s.name+'</h2><div class="mt-1 flex flex-wrap gap-2 text-xs"><span class="inline-flex items-center rounded-full px-2 py-1 bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-300">Повітряна тривога</span></div></div><div class="text-xs text-gray-500 text-right">початок/зміна: <span class="mono">'+fmtTime(s.changed)+'</span></div>';
          card.appendChild(header);
          const body=document.createElement("div");
          body.className="mt-3";
          body.innerHTML='<p class="text-sm text-gray-600 dark:text-gray-400">Показано регіональний рівень. Якщо з’явиться публічний фід міст/громад без ключів, його можна підключити.</p>';
          card.appendChild(body);
          container.appendChild(card);
        }
      }
      document.getElementById("regionsCount").textContent=active.length;
      document.getElementById("updated").textContent=new Date().toLocaleString("uk-UA",{timeZone:KYIV_TZ,hour12:false});
    }

    async function tick(){
      try{
        const json=await ADAPTER.load();
        const states=ADAPTER.parse(json);
        render(states);
      }catch(e){
        document.getElementById("list").innerHTML='<div class="p-4 rounded-xl border border-red-300/50 bg-red-50 dark:bg-red-900/20 text-red-700 dark:text-red-200">Не вдалося завантажити дані. Перевір адресу '+ENDPOINT+'.</div>';
      }finally{
        setTimeout(tick,POLL_MS);
      }
    }

    tick();
  </script>
</body>
</html>

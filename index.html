<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Повітряні тривоги — області та райони</title>
  <meta name="color-scheme" content="light dark" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    :root{
      --accent:#2563eb;
      --bg:#f8fafc;
      --card-bg:#ffffff;
      --card-border:#e6edf6;
      --text:#0f1724;
      --muted:#6b7280;
      --muted-text:#475569;
      --legend-bg: rgba(12,12,18,0.92);
      --legend-text: #ffffff;
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg:#030312;
        --card-bg:#071226;
        --card-border:#0b2236;
        --text:#e6eef8;
        --muted-text:#9aa8bf;
      }
    }

    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased}
    .container{max-width:1100px;margin:20px auto;padding:18px}
    header{display:flex;gap:12px;align-items:flex-end}
    h1{margin:0;font-size:20px;font-weight:700}
    .muted{color:var(--muted-text);font-size:13px}
    .controls{margin-top:12px;display:flex;gap:12px;align-items:center;flex-wrap:wrap;background:var(--card-bg);border:1px solid var(--card-border);padding:12px;border-radius:12px}
    .left{display:flex;gap:8px;align-items:center}
    .right{margin-left:auto;display:flex;gap:8px;align-items:center}
    input[type="text"],select,input[type="number"]{border-radius:8px;padding:8px 10px;border:1px solid var(--card-border);min-height:40px;background:transparent;color:var(--text)}
    input::placeholder{color:#9aa8bf}
    .btn{display:inline-flex;gap:8px;align-items:center;padding:10px 14px;border-radius:10px;cursor:pointer;border:0;background:var(--accent);color:white;font-weight:700}
    .btn.ghost{background:transparent;color:var(--accent);border:1px solid rgba(37,99,235,0.12)}
    .btn.secondary{background:#374151}
    .small{font-size:13px;color:var(--muted-text)}
    #out{margin-top:14px}
    .region-card{background:var(--card-bg);border:1px solid var(--card-border);border-radius:10px;padding:12px;margin-top:10px}
    .post{padding:10px;border-radius:8px;margin-top:8px;border:1px solid rgba(0,0,0,0.03)}
    .post .top{display:flex;justify-content:space-between;align-items:center}
    .post .title{font-weight:700}
    .post .time{color:var(--muted-text);font-size:13px}
    .raw-block{margin-top:12px;padding:10px;border:1px dashed var(--card-border);border-radius:8px;color:var(--muted-text)}
    .map-modal{position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.55);display:flex;align-items:stretch;justify-content:center;z-index:9999}
    .map-panel{width:94%;max-width:1200px;margin:auto;background:var(--card-bg);border-radius:10px;overflow:hidden;display:flex;flex-direction:column;height:84vh;box-shadow:0 12px 40px rgba(2,6,23,0.4)}
    .map-header{display:flex;align-items:center;gap:12px;padding:10px 12px;border-bottom:1px solid var(--card-border)}
    .map-body{flex:1;position:relative}
    #map{width:100%;height:100%}
    .map-legend{position:absolute;right:12px;top:12px;padding:10px;border-radius:8px;font-size:13px;color:var(--legend-text);z-index:400;background:var(--legend-bg);border:1px solid rgba(255,255,255,0.06)}
    .legend-row{display:flex;gap:8px;align-items:center;margin-bottom:6px;color:var(--legend-text)}
    .swatch{width:20px;height:14px;border-radius:3px;display:inline-block}
    .map-footer{padding:8px 12px;border-top:1px solid var(--card-border);display:flex;justify-content:space-between;align-items:center;gap:10px}
    .hidden{display:none}
    .hamburger{position:fixed;left:18px;top:18px;width:46px;height:46px;border-radius:10px;background:var(--card-bg);border:1px solid var(--card-border);display:flex;align-items:center;justify-content:center;z-index:10001;cursor:pointer;box-shadow:0 6px 18px rgba(2,6,23,0.06)}
    .ham-lines{width:22px;height:2px;background:var(--text);display:block;position:relative;transition:background .2s}
    .ham-lines::before,.ham-lines::after{content:"";position:absolute;left:0;width:22px;height:2px;background:var(--text);transition:transform .28s,top .28s,opacity .28s}
    .ham-lines::before{top:-7px}
    .ham-lines::after{top:7px}
    .hamburger.open .ham-lines{background:transparent}
    .hamburger.open .ham-lines::before{transform:rotate(45deg); top:0}
    .hamburger.open .ham-lines::after{transform:rotate(-45deg); top:0}
    .menu-panel{position:fixed;left:18px;top:72px;width:260px;background:var(--card-bg);border:1px solid var(--card-border);border-radius:10px;padding:10px;box-shadow:0 14px 40px rgba(2,6,23,0.12);z-index:10000;transform-origin:top left;transform:scale(.96);opacity:0;pointer-events:none;transition:transform .16s,opacity .16s}
    .menu-panel.open{transform:scale(1);opacity:1;pointer-events:auto}
    .menu-button{display:flex;align-items:center;gap:8px;padding:10px;border-radius:8px;border:0;background:transparent;cursor:pointer;width:100%;text-align:left;font-weight:700}
    .menu-button.primary{background:var(--accent);color:white}
    .menu-section{margin-top:8px}
    .mode-switch{padding:6px 8px;border-radius:8px;border:1px solid var(--card-border);background:transparent;cursor:pointer}
    @media (max-width:800px){.controls{flex-direction:column;align-items:stretch}.right{margin-left:0;justify-content:flex-start}.menu-panel{left:12px;width:86vw}}
  </style>
</head>
<body>
  <div class="hamburger" id="hamburger" aria-label="Меню" title="Меню">
    <span class="ham-lines" id="hamLines" aria-hidden="true"></span>
  </div>

  <div class="menu-panel" id="menuPanel" aria-hidden="true" role="menu">
    <button class="menu-button primary" id="menuLoad">Завантажити</button>
    <button class="menu-button" id="menuForce">Примусово</button>
    <button class="menu-button" id="menuOpenMap">Відкрити карту</button>
    <div class="menu-section">
      <div style="font-weight:700;margin-bottom:6px">Райони (опціонально)</div>
      <button class="menu-button" id="menuLoadRayonUrl">Завантажити GeoJSON (URL)</button>
      <button class="menu-button" id="menuUploadRayonFile">Завантажити GeoJSON (файл)</button>
    </div>
    <div class="menu-section">
      <button class="menu-button" id="menuResetBackoff">Скинути backoff</button>
    </div>
  </div>

  <div class="container">
    <header>
      <div>
        <h1 id="pageTitle">Повітряні тривоги — області та райони</h1>
        <div class="muted" id="subtitle">Показує тільки сьогоднішні пости. Відкрийте меню (ліворуч) для швидких дій.</div>
      </div>
      <div style="margin-left:auto;text-align:right">
        <div class="small">Worker: <strong id="workerHost">dawn-bird-9d4d.nevaznoa855.workers.dev</strong></div>
      </div>
    </header>

    <section class="controls" role="region" aria-label="Налаштування">
      <div class="left">
        <label for="channelInput" class="small" style="margin-right:6px">Канал</label>
        <input id="channelInput" type="text" value="kpszsu" placeholder="kpszsu або https://t.me/kpszsu або ID" />
        <button id="loadBtn" class="btn">Завантажити</button>
        <button id="forceBtn" class="btn ghost">Примусово</button>
      </div>

      <div class="right">
        <label class="small">Постів</label>
        <select id="countSelect"><option value="10">10</option><option value="20" selected>20</option><option value="30">30</option></select>
        <label class="small">Інтервал (c)</label>
        <input id="intervalInput" type="number" min="10" value="30" style="width:80px" />
        <label style="display:flex;align-items:center;gap:8px"><input id="showRawAlways" type="checkbox" checked /> <span class="small">Сирі пости</span></label>
        <button id="openMapBtn" class="btn">Відкрити карту</button>
      </div>
    </section>

    <div style="margin-top:10px;display:flex;gap:12px;align-items:center;">
      <div class="small">Статус: <strong id="statusText">—</strong></div>
      <div id="diag" class="small" style="color:#b91c1c"></div>
    </div>

    <div id="summary" style="margin-top:10px;display:flex;gap:10px;align-items:center;flex-wrap:wrap">
      <div style="background:var(--card-bg);border:1px solid var(--card-border);padding:8px;border-radius:10px;font-weight:700">Областей згадано: <span id="oblastsCount">0</span></div>
      <div style="background:var(--card-bg);border:1px solid var(--card-border);padding:8px;border-radius:10px;font-weight:700">Міст згадано: <span id="citiesCount">0</span></div>
      <div id="citiesList" class="small"></div>
    </div>

    <div id="out"></div>
    <div id="raw" class="raw-block" style="display:none"></div>
  </div>

  <div id="mapModal" class="map-modal hidden" aria-hidden="true" role="dialog" aria-label="Карта областей">
    <div class="map-panel" role="document">
      <div class="map-header">
        <button id="closeMapBtn" class="btn ghost">Закрити карту</button>
        <div style="margin-left:12px;font-weight:700">Карта України — області / райони</div>
        <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
          <div class="small">Режим:</div>
          <select id="mapMode" class="mode-switch"><option value="oblast">області</option><option value="rayon">райони</option></select>
        </div>
      </div>
      <div class="map-body">
        <div id="map"></div>
        <div id="legend" class="map-legend" aria-hidden="false">
          <div style="font-weight:700;margin-bottom:6px;color:#fff">Легенда</div>
          <div class="legend-row"><span class="swatch" style="background:#7a0177"></span><span> дуже багато згадок</span></div>
          <div class="legend-row"><span class="swatch" style="background:#c51b8a"></span><span> багато</span></div>
          <div class="legend-row"><span class="swatch" style="background:#f768a1"></span><span> помірно</span></div>
          <div class="legend-row"><span class="swatch" style="background:#fa9fb5"></span><span> кілька згадок</span></div>
          <div class="legend-row"><span class="swatch" style="background:#fde0ef"></span><span> 1 згадка</span></div>
        </div>
      </div>
      <div class="map-footer">
        <div class="small">Дані: сьогоднішні пости каналу</div>
        <div style="display:flex;gap:8px">
          <button id="loadRayonUrlBtn" class="btn ghost">Вставити URL GeoJSON районів</button>
          <label class="btn ghost" style="display:inline-flex;align-items:center;gap:8px;cursor:pointer">Завантажити файл<input type="file" id="rayonFileInput" accept=".geojson,.json" style="display:none"></label>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    const WORKER_BASE = "https://dawn-bird-9d4d.nevaznoa855.workers.dev/?channel=";
    const KYIV_TZ = "Europe/Kyiv";
    const OBLAST_PAIRS = [
      { oblast: "Вінницька", noun: "Вінниця" },
      { oblast: "Волинська", noun: "Волинь" },
      { oblast: "Дніпропетровська", noun: "Дніпро" },
      { oblast: "Донецька", noun: "Донецьк" },
      { oblast: "Житомирська", noun: "Житомир" },
      { oblast: "Закарпатська", noun: "Закарпаття" },
      { oblast: "Запорізька", noun: "Запоріжжя" },
      { oblast: "Івано-Франківська", noun: "Івано-Франківськ" },
      { oblast: "Київська", noun: "Київська" },
      { oblast: "Кіровоградська", noun: "Кропивницький" },
      { oblast: "Луганська", noun: "Луганськ" },
      { oblast: "Львівська", noun: "Львів" },
      { oblast: "Миколаївська", noun: "Миколаїв" },
      { oblast: "Одеська", noun: "Одеса" },
      { oblast: "Полтавська", noun: "Полтава" },
      { oblast: "Рівненська", noun: "Рівне" },
      { oblast: "Сумська", noun: "Суми" },
      { oblast: "Тернопільська", noun: "Тернопіль" },
      { oblast: "Харківська", noun: "Харків" },
      { oblast: "Херсонська", noun: "Херсон" },
      { oblast: "Хмельницька", noun: "Хмельницький" },
      { oblast: "Черкаська", noun: "Черкаси" },
      { oblast: "Чернівецька", noun: "Чернівці" },
      { oblast: "Чернігівська", noun: "Чернігів" },
      { oblast: "м. Київ", noun: "Київ" },
      { oblast: "м. Севастополь", noun: "Севастополь" }
    ];

    const mapGeoUrl = "https://cdn.jsdelivr.net/gh/leakyMirror/map-of-ukraine@master/GeoJSON/ukraine.geo.json";

    const channelInput = document.getElementById("channelInput");
    const loadBtn = document.getElementById("loadBtn");
    const forceBtn = document.getElementById("forceBtn");
    const openMapBtn = document.getElementById("openMapBtn");
    const closeMapBtn = document.getElementById("closeMapBtn");
    const loadRayonUrlBtn = document.getElementById("loadRayonUrlBtn");
    const rayonFileInput = document.getElementById("rayonFileInput");
    const hamburger = document.getElementById("hamburger");
    const menuPanel = document.getElementById("menuPanel");
    const hamLines = document.getElementById("hamLines");
    const menuLoad = document.getElementById("menuLoad");
    const menuForce = document.getElementById("menuForce");
    const menuOpenMap = document.getElementById("menuOpenMap");
    const menuLoadRayonUrl = document.getElementById("menuLoadRayonUrl");
    const menuUploadRayonFile = document.getElementById("menuUploadRayonFile");
    const menuResetBackoff = document.getElementById("menuResetBackoff");

    const countSelect = document.getElementById("countSelect");
    const intervalInput = document.getElementById("intervalInput");
    const showRawAlways = document.getElementById("showRawAlways");
    const out = document.getElementById("out");
    const rawBlock = document.getElementById("raw");
    const statusText = document.getElementById("statusText");
    const diag = document.getElementById("diag");
    const oblastsCountEl = document.getElementById("oblastsCount");
    const citiesCountEl = document.getElementById("citiesCount");
    const citiesListEl = document.getElementById("citiesList");
    const mapModal = document.getElementById("mapModal");
    const mapMode = document.getElementById("mapMode");

    let backoffMs = parseInt(localStorage.getItem("backoffMs")||"0",10) || 0;
    let consecutiveEmpty = parseInt(localStorage.getItem("consecutiveEmpty")||"0",10) || 0;
    let POLL_TIMER = null;
    let lastSavedPosts = [];
    let lastOblastCounts = {};
    let lastRayonCounts = {};
    let geoJsonOblast = null;
    let geoJsonRayon = null;
    let map = null;
    let geoLayer = null;

    function nowStr(){ try { return new Date().toLocaleString("uk-UA",{timeZone:KYIV_TZ,hour12:false}); } catch(e){ return new Date().toString(); } }
    function buildWorkerUrl(channel, extra){ const e = extra ? "&"+extra.replace(/^[&?]+/,"") : ""; return WORKER_BASE + encodeURIComponent(channel) + e; }
    async function fetchFromWorker(channel, extra){ const url = buildWorkerUrl(channel, extra); const r = await fetch(url, { cache: "no-store" }); if(!r.ok){ const txt = await r.text().catch(()=> ""); throw new Error("HTTP "+r.status + " " + (txt.slice? txt.slice(0,400) : String(txt))); } return r.json(); }

    function normalizeChannelInput(raw){ if(!raw) return ""; raw = raw.trim(); if(raw.startsWith("@")) raw = raw.slice(1); try{ const u = new URL(raw); const p = u.pathname.replace(/^\/+|\/+$/g,""); if(p.length>0) return p.split("/")[0]; return raw; }catch(e){ return raw; } }
    function parseDateToMillis(pubDate){ if(!pubDate) return 0; const d = Date.parse(pubDate); if(!isNaN(d)) return d; const timeOnly = String(pubDate).trim().match(/^\d{1,2}:\d{2}$/); if(timeOnly){ const now = new Date(); const [hh,mm] = String(pubDate).split(":").map(Number); const dd = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hh, mm); return dd.getTime(); } return 0; }
    function getKyivDateString(ms){ try{ const d = new Date(ms); return new Intl.DateTimeFormat("en-CA", { timeZone: KYIV_TZ }).format(d); }catch(e){ return ""; } }
    function formatKyiv(pubDate){ try{ const d = new Date(pubDate); if(isNaN(d)) return pubDate || ""; return d.toLocaleString("uk-UA",{timeZone:KYIV_TZ, hour12:false, year:"numeric", month:"2-digit", day:"2-digit", hour:"2-digit", minute:"2-digit"}); }catch(e){ return pubDate||""; } }

    function normalizeName(s){
      if(!s) return "";
      try{
        return String(s).toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9а-яіїєґ'\-\s]/giu,"").replace(/\s+/g," ").trim();
      }catch(e){ return String(s).toLowerCase().replace(/\s+/g," ").trim(); }
    }

    function escapeRegex(s){ return s.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"); }
    function capitalizeUkr(s){ return s.replace(/\s+/g," ").replace(/(^|\s)([а-яіїєґA-ЯІЇЄҐ])/gu, (m, a, b)=> a + b.toUpperCase()); }
    function validCityName(name){ if(!name) return false; if(name.length < 3) return false; const stop = ["область","області","район","району","місто","міст","село","смт","курсом","півночі","півдні","захід","схід"]; const lower = name.toLowerCase(); for(const s of stop) if(lower.indexOf(s) !== -1) return false; return true; }

    function extractOblastsFromText(text){
      const found = new Set();
      if(!text) return [];
      const ntext = normalizeName(text);
      for(const p of OBLAST_PAIRS){
        const candidates = [p.oblast, p.noun, p.noun.replace(/(ь|а|я|й|о|и|і)$/iu,"")].map(c=>normalizeName(c));
        for(const c of candidates){
          if(!c) continue;
          if(ntext.indexOf(c) !== -1) found.add(p.oblast);
        }
      }
      return Array.from(found);
    }

    function extractCitiesFromText(text){
      const cities = [];
      if(!text) return cities;
      const explicit = new RegExp("\\b(?:м\\.|м|місто|смт|с\\.|селище)\\s*([А-ЯІЇЄҐ][а-яіїєґ'\\-\\s]{1,60})","giu");
      let m;
      while((m = explicit.exec(text)) !== null){
        const name = m[1].trim().replace(/\s+/g," ");
        if(validCityName(name)) cities.push(capitalizeUkr(name));
      }
      const prep = new RegExp("\\b(?:в|у|на|біля|поблизу|околицях|районі|р-ні|район)\\s+([А-ЯІЇЄҐ][а-яіїєґ'\\-\\s]{2,60})","giu");
      while((m = prep.exec(text)) !== null){
        const name = m[1].trim().replace(/[.,:;!?)]+$/,"").replace(/\s+/g," ");
        if(validCityName(name)) cities.push(capitalizeUkr(name));
      }
      const uniq = Array.from(new Set(cities));
      return uniq;
    }

    function loadLastPosts(){ try{ const s = localStorage.getItem("lastPosts"); return s ? JSON.parse(s) : null; }catch(e){ return null; } }
    function saveLastPosts(posts){
      try{
        const todayStr = getKyivDateString(Date.now());
        const onlyToday = (posts||[]).filter(p=> p.dateKyiv === todayStr);
        localStorage.setItem("lastPosts", JSON.stringify(onlyToday));
        localStorage.setItem("lastFetchedAt", new Date().toISOString());
        localStorage.setItem("consecutiveEmpty","0");
        consecutiveEmpty = 0;
        lastSavedPosts = onlyToday;
      }catch(e){}
    }

    async function analyze(channel, options={force:false}){
      try{
        diag.textContent = "";
        loadBtn.setAttribute("disabled","true");
        forceBtn.setAttribute("disabled","true");

        if(backoffMs > 0 && !options.force){
          diag.textContent = "Backoff активний: чекати " + Math.round(backoffMs/1000) + " c";
          await new Promise(r=>setTimeout(r, backoffMs));
        }

        const resp = await fetchFromWorker(channel);
        let items = [];
        if(Array.isArray(resp?.items)) items = resp.items;
        else if(Array.isArray(resp?.data?.items)) items = resp.data.items;
        else if(Array.isArray(resp)) items = resp;
        else if(Array.isArray(resp?.data)) items = resp.data;

        const normalized = (items||[]).map(it => {
          const id = it.id || it.link || it.url || it.guid || (it.link?it.link:JSON.stringify(it)).slice(0,200);
          const link = it.url || it.link || it.guid || "";
          const title = it.title || "";
          const description = (it.content_html || it.description || it.content || "").replace(/<\/?[^>]+(>|$)/g,"").trim();
          const pubDate = it.date_published || it.pubDate || it.isoDate || it.pubdate || "";
          const ts = parseDateToMillis(pubDate);
          const dateKyiv = ts ? getKyivDateString(ts) : (pubDate ? getKyivDateString(Date.now()) : "");
          return { id, link, title, description, pubDate, ts, dateKyiv };
        });

        const todayKyiv = getKyivDateString(Date.now());
        const onlyToday = normalized.filter(p => p.dateKyiv === todayKyiv && (p.ts || 0) > 0);
        onlyToday.sort((a,b)=> (b.ts || 0) - (a.ts || 0));

        if(onlyToday.length > 0){
          const saved = loadLastPosts() || [];
          const savedIds = new Set((saved||[]).map(p=>p.id||p.link));
          const newPosts = [];
          for(const p of onlyToday){
            const key = p.id || p.link || (p.title + p.pubDate);
            if(!savedIds.has(key)) newPosts.push(p);
          }

          if(newPosts.length>0){
            renderAndAnimateDiff(onlyToday, newPosts, channel);
            saveLastPosts(onlyToday);
          } else {
            renderAll(onlyToday, channel, false);
            saveLastPosts(onlyToday);
          }

          setChannelStatus(true, "відкритий");
          backoffMs = 0; consecutiveEmpty = 0; localStorage.removeItem("backoffMs"); localStorage.removeItem("consecutiveEmpty");
        } else {
          consecutiveEmpty = (parseInt(localStorage.getItem("consecutiveEmpty")||"0",10)||0) + 1;
          localStorage.setItem("consecutiveEmpty", String(consecutiveEmpty));
          const saved = loadLastPosts() || [];
          const filterSavedToday = (saved||[]).filter(p => p.dateKyiv === todayKyiv);
          if(filterSavedToday.length>0){
            renderAll(filterSavedToday, channel, true);
            setChannelStatus(false, "тимчасово недоступний");
            diag.textContent = "Немає постів за сьогодні; показано останні відомі пости сьогодні. Порожніх відповідей поспіль: " + consecutiveEmpty;
            if(consecutiveEmpty >= 2) setChannelStatus(false, "закритий");
          } else {
            out.innerHTML = "<div style='padding:12px;border-radius:10px;background:#fff7ed;color:#92400e'>Сьогодні постів немає.</div>";
            setChannelStatus(false, "закритий");
            diag.textContent = "За сьогодні постів не знайдено.";
          }
          backoffMs = backoffMs ? Math.min(backoffMs*2, 300000) : 5000;
          localStorage.setItem("backoffMs", String(backoffMs));
        }
      }catch(e){
        backoffMs = backoffMs ? Math.min(backoffMs*2, 300000) : 5000;
        localStorage.setItem("backoffMs", String(backoffMs));
        setChannelStatus(false, "недоступний");
        const todayKyiv = getKyivDateString(Date.now());
        const saved = loadLastPosts() || [];
        const filterSavedToday = (saved||[]).filter(p => p.dateKyiv === todayKyiv);
        if(filterSavedToday.length>0){
          renderAll(filterSavedToday, normalizeChannelInput(channelInput.value||""), true);
          diag.textContent = "Помилка: " + String(e) + " — показано збережені (сьогодні). Backoff: " + Math.round(backoffMs/1000) + " c";
        } else {
          out.innerHTML = '<div style="padding:12px;border-radius:10px;background:#fff0f0;color:#b91c1c">Не вдалося завантажити дані. Помилка: '+String(e)+'</div>';
          diag.textContent = String(e);
        }
      } finally {
        loadBtn.removeAttribute("disabled");
        forceBtn.removeAttribute("disabled");
      }
    }

    function setChannelStatus(open, text){
      statusText.textContent = text || (open ? "відкритий" : "закритий");
    }

    function renderAll(posts, channel, isStale){
      const groups = {};
      const allOblastsFound = new Set();
      const cityCounts = {};
      for(const p of posts){
        const text = (p.title || "") + " " + (p.description || "");
        const oblasts = extractOblastsFromText(text);
        for(const o of oblasts) allOblastsFound.add(o);
        const cities = extractCitiesFromText(text);
        for(const c of cities){ cityCounts[c] = (cityCounts[c]||0) + 1; }
        if(oblasts.length===0){
          if(!groups["Інші"]) groups["Інші"] = [];
          groups["Інші"].push(p);
        } else {
          for(const o of oblasts){ if(!groups[o]) groups[o]=[]; groups[o].push(p); }
        }
      }

      out.innerHTML = "";
      const oblastKeys = Object.keys(groups).sort((a,b)=>a.localeCompare(b,"uk"));
      for(const oblast of oblastKeys){
        const card = document.createElement("section");
        card.className = "region-card";
        const header = document.createElement("div");
        header.style.display = "flex"; header.style.justifyContent = "space-between"; header.style.alignItems="center";
        header.innerHTML = '<div style="font-weight:700">'+oblast+'</div><div style="color:var(--muted-text)">згадок: <strong>'+groups[oblast].length+'</strong></div>';
        card.appendChild(header);
        for(const p of groups[oblast]){
          const node = makePostNode(p, channel);
          card.appendChild(node);
        }
        out.appendChild(card);
      }

      oblastsCountEl.textContent = String(allOblastsFound.size);
      const cityKeys = Object.keys(cityCounts).sort((a,b)=>cityCounts[b]-cityCounts[a]);
      citiesCountEl.textContent = String(cityKeys.length);
      citiesListEl.innerHTML = cityKeys.slice(0,10).map(k=>k + " ("+cityCounts[k]+")").join(", ");

      lastOblastCounts = {};
      for(const k of Array.from(allOblastsFound)){ lastOblastCounts[k] = groups[k] ? groups[k].length : 0; }
      lastRayonCounts = {};
      if(showRawAlways.checked) renderRaw(posts); else rawBlock.style.display = "none";
    }

    function makePostNode(p, channel){
      const div = document.createElement("article"); div.className="post"; div.dataset.id = p.id || p.link || (p.title + p.pubDate);
      const top = document.createElement("div"); top.className="top";
      const title = document.createElement("div"); title.className="title"; title.textContent = p.title || (p.description ? p.description.slice(0,140) : "(без заголовка)");
      const time = document.createElement("div"); time.className="time"; time.textContent = formatKyiv(p.pubDate || p.ts || "");
      top.appendChild(title); top.appendChild(time);
      div.appendChild(top);
      const body = document.createElement("div"); body.textContent = p.description || ""; body.style.color = "var(--muted-text)";
      div.appendChild(body);
      const actions = document.createElement("div"); actions.style.marginTop="8px";
      const open = document.createElement("a"); open.href = p.link || ("https://t.me/" + encodeURIComponent(channel)); open.target="_blank"; open.rel="noopener noreferrer"; open.textContent = "Відкрити в Telegram"; open.className="btn ghost";
      actions.appendChild(open); div.appendChild(actions);
      return div;
    }

    function renderRaw(posts){
      rawBlock.style.display = "block"; rawBlock.innerHTML = "<strong>Сирі останні пости (сьогодні)</strong>";
      if(posts.length===0){ rawBlock.innerHTML += "<div style='margin-top:8px;'>Немає постів.</div>"; return; }
      for(const p of posts){
        const wrap = document.createElement("div"); wrap.style.marginTop="8px"; wrap.style.padding="8px"; wrap.style.borderRadius="8px"; wrap.style.background="rgba(0,0,0,0.02)";
        const title = document.createElement("div"); title.style.fontWeight="700"; title.textContent = p.title || "";
        const when = document.createElement("div"); when.style.fontSize="13px"; when.style.color="var(--muted-text)"; when.textContent = formatKyiv(p.pubDate||p.ts||"");
        const pre = document.createElement("pre"); pre.style.whiteSpace="pre-wrap"; pre.textContent = p.description || "";
        const link = document.createElement("a"); link.href = p.link || ("https://t.me/" + encodeURIComponent(normalizeChannelInput(channelInput.value||""))); link.target="_blank"; link.rel="noopener noreferrer"; link.textContent = "Відкрити в Telegram"; link.className="btn ghost"; link.style.display="inline-block"; link.style.marginTop="8px";
        wrap.appendChild(title); wrap.appendChild(when); wrap.appendChild(pre); wrap.appendChild(link);
        rawBlock.appendChild(wrap);
      }
    }

    function renderAndAnimateDiff(allPosts, newPosts, channel){
      renderAll(allPosts, channel, false);
      if(newPosts.length===0) return;
      setTimeout(()=>{
        const ids = new Set(newPosts.map(p=>p.id||p.link||(p.title+p.pubDate)));
        const nodes = out.querySelectorAll("[data-id]");
        let firstSeen = null;
        for(const n of nodes){
          const nid = n.dataset.id;
          if(ids.has(nid)){
            n.style.transition = "box-shadow .3s, transform .3s";
            n.style.boxShadow = "0 10px 30px rgba(37,99,235,0.12)";
            n.style.transform = "translateY(-6px)";
            setTimeout(()=>{ n.style.boxShadow=""; n.style.transform=""; }, 1600);
            if(!firstSeen) firstSeen = n;
          }
        }
        if(firstSeen) firstSeen.scrollIntoView({behavior:"smooth", block:"start"});
      }, 120);
    }

    function startPolling(channel){
      if(POLL_TIMER) clearInterval(POLL_TIMER);
      const sec = Math.max(10, parseInt(intervalInput.value,10) || 30);
      const effective = Math.max(sec*1000, backoffMs || 0);
      POLL_TIMER = setInterval(()=>analyze(channel).catch(()=>{}), effective);
      analyze(channel).catch(()=>{});
    }

    // --- Map / GeoJSON ---
    let geoJsonOblast = null;
    let geoJsonRayon = null;
    function initMap(){
      if(map) return;
      map = L.map("map", { zoomControl:true }).setView([49,31], 6);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { attribution: '© OpenStreetMap' }).addTo(map);
    }

    function defaultStyle(feature){ return { color:"#444", weight:1, fillColor:"#f2f2f2", fillOpacity:0.6 }; }
    function highlightStyle(count){
      if(count >= 10) return { fillColor: "#7a0177", fillOpacity: 0.85, color:"#4b0056", weight:1.6 };
      if(count >= 6) return { fillColor: "#c51b8a", fillOpacity: 0.8, color:"#7a0256", weight:1.4 };
      if(count >= 3) return { fillColor: "#f768a1", fillOpacity: 0.75, color:"#a01a5f", weight:1.2 };
      if(count >= 2) return { fillColor: "#fa9fb5", fillOpacity: 0.72, color:"#b5476f", weight:1.0 };
      return { fillColor: "#fde0ef", fillOpacity: 0.7, color:"#d07c9b", weight:0.9 };
    }

    function getFeatureNames(feature){
      const p = feature.properties || {};
      const out = [];
      if(p.name) out.push(p.name);
      if(p.NAME_1) out.push(p.NAME_1);
      if(p.name_uk) out.push(p.name_uk);
      if(p.admin) out.push(p.admin);
      if(p.NAME) out.push(p.NAME);
      if(p.name_en) out.push(p.name_en);
      return out.filter(Boolean);
    }

    function normalizeName(s){
      if(!s) return "";
      try{
        return String(s).toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9а-яіїєґ'\-\s]/giu,"").replace(/\s+/g," ").trim();
      }catch(e){ return String(s).toLowerCase().replace(/\s+/g," ").trim(); }
    }

    function findMentionCountForFeature(feature){
      const names = getFeatureNames(feature).map(s => normalizeName(s));
      const mode = mapMode.value || "oblast";
      if(mode === "rayon" && Object.keys(lastRayonCounts || {}).length > 0){
        for(const n of names){
          for(const rc in lastRayonCounts){
            if(n.indexOf(normalizeName(rc)) !== -1) return lastRayonCounts[rc] || 0;
          }
        }
      }
      if(mode === "oblast"){
        for(const n of names){
          for(const pair of OBLAST_PAIRS){
            const cands = [pair.oblast, pair.noun, pair.noun.replace(/(ь|а|я|й|о|и|і)$/iu,"")].map(x=>normalizeName(x));
            for(const c of cands){
              if(c && n.indexOf(c) !== -1) return lastOblastCounts[pair.oblast] || 0;
            }
          }
        }
      }
      return 0;
    }

    function onEachFeature(feature, layer){
      const names = getFeatureNames(feature).join(" / ");
      layer.on({
        mouseover: function(e){ e.target.setStyle({ weight:2, fillOpacity:0.95 }); },
        mouseout: function(e){ if(geoLayer) geoLayer.resetStyle(e.target); },
        click: function(e){
          const cnt = findMentionCountForFeature(feature) || 0;
          layer.bindPopup("<strong>"+names+"</strong><div class='small'>Згадок: "+cnt+"</div>").openPopup();
        }
      });
    }

    async function loadGeoJsonOblast(){
      try{
        const r = await fetch(mapGeoUrl);
        if(!r.ok) throw new Error("HTTP " + r.status);
        geoJsonOblast = await r.json();
        diag.textContent = "";
      }catch(e){
        geoJsonOblast = null;
        diag.textContent = "Проблема з GeoJSON областей: " + String(e);
      }
    }

    async function paintMap(){
      if(!map) initMap();
      const mode = mapMode.value || "oblast";
      const source = (mode === "rayon") ? geoJsonRayon : geoJsonOblast;
      if(!source){
        diag.textContent = "GeoJSON для режиму " + mode + " не завантажено.";
        return;
      }
      if(geoLayer) geoLayer.remove();
      geoLayer = L.geoJSON(source, { style: function(feature){
        const cnt = findMentionCountForFeature(feature);
        if(cnt > 0) return highlightStyle(cnt);
        return defaultStyle(feature);
      }, onEachFeature: onEachFeature }).addTo(map);
      try{ map.fitBounds(geoLayer.getBounds(), { padding:[20,20] }); }catch(e){}
      setTimeout(()=>{ if(map) map.invalidateSize(); }, 200);
    }

    // --- menu and UI handlers ---
    hamburger.addEventListener("click", ()=>{
      const open = menuPanel.classList.toggle("open");
      hamburger.classList.toggle("open", open);
    });
    menuLoad.addEventListener("click", ()=> loadBtn.click());
    menuForce.addEventListener("click", ()=> forceBtn.click());
    menuOpenMap.addEventListener("click", ()=> openMapBtn.click());
    menuLoadRayonUrl.addEventListener("click", ()=> loadRayonUrlBtn.click());
    menuUploadRayonFile.addEventListener("click", ()=> rayonFileInput.click());
    menuResetBackoff.addEventListener("click", ()=> {
      backoffMs = 0; consecutiveEmpty = 0; localStorage.removeItem("backoffMs"); localStorage.removeItem("consecutiveEmpty");
      diag.textContent = "Backoff скинуто вручну.";
      const raw = channelInput.value.trim();
      if(raw) analyze(normalizeChannelInput(raw), {force:true});
    });

    document.getElementById("menuLoadRayonUrl").addEventListener("click", ()=> loadRayonUrlBtn.click());

    // map open/close
    openMapBtn.addEventListener("click", async ()=>{
      mapModal.classList.remove("hidden");
      mapModal.style.display = "flex";
      if(!map) initMap();
      if(!geoJsonOblast) await loadGeoJsonOblast();
      await paintMap();
    });
    closeMapBtn.addEventListener("click", ()=> { mapModal.classList.add("hidden"); mapModal.style.display = "none"; });

    // rayon url/file
    const explicitLoadRayon = document.getElementById("loadRayonUrlBtn");
    explicitLoadRayon.addEventListener("click", async ()=>{
      const url = prompt("Вставте URL до GeoJSON з районами (публічний URL, потрібно CORS):");
      if(!url) return;
      diag.textContent = "Завантаження GeoJSON районів...";
      try{
        const r = await fetch(url);
        if(!r.ok) throw new Error("HTTP " + r.status);
        geoJsonRayon = await r.json();
        diag.textContent = "GeoJSON районів завантажено.";
        mapMode.value = "rayon";
        await paintMap();
      }catch(e){
        diag.textContent = "Помилка: " + String(e);
      }
    });

    rayonFileInput.addEventListener("change", async (ev)=>{
      const f = ev.target.files && ev.target.files[0];
      if(!f) return;
      const txt = await f.text();
      try{
        geoJsonRayon = JSON.parse(txt);
        diag.textContent = "GeoJSON районів завантажений з файлу.";
        mapMode.value = "rayon";
        await paintMap();
      }catch(e){
        diag.textContent = "Помилка розбору файлу: " + String(e);
      }
    });

    // main controls
    loadBtn.addEventListener("click", ()=>{
      const raw = channelInput.value.trim();
      if(!raw) return alert("Вкажіть канал або ID.");
      const channel = normalizeChannelInput(raw);
      localStorage.setItem("lastChannel", channel);
      startPolling(channel);
    });

    forceBtn.addEventListener("click", ()=> {
      const raw = channelInput.value.trim();
      if(!raw) return;
      backoffMs = 0; localStorage.removeItem("backoffMs");
      analyze(normalizeChannelInput(raw), {force:true});
    });

    // init on load
    document.addEventListener("DOMContentLoaded", ()=>{
      const lastFetched = localStorage.getItem("lastFetchedAt");
      if(lastFetched){
        const savedDay = getKyivDateString(new Date(lastFetched).getTime());
        const today = getKyivDateString(Date.now());
        if(savedDay !== today){
          localStorage.removeItem("lastPosts");
          localStorage.removeItem("lastFetchedAt");
        }
      }
      const saved = localStorage.getItem("lastChannel");
      if(saved) channelInput.value = saved;
      const initial = normalizeChannelInput(channelInput.value||"kpszsu");
      if(initial) startPolling(initial);
      loadGeoJsonOblast();
    });

    // small helper to expose worker base for buildWorkerUrl used in fetchFromWorker
    function buildWorkerUrl(channel, extra){ const e = extra ? "&"+extra.replace(/^[&?]+/,"") : ""; return WORKER_BASE + encodeURIComponent(channel) + e; }

    // expose WORKER_BASE constant (kept safe)
    const WORKER_BASE = "https://dawn-bird-9d4d.nevaznoa855.workers.dev/?channel=";

    // done
  </script>
</body>
</html>

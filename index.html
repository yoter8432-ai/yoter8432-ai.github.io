<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Перегляд Telegram-каналів — повітряні тривоги</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="color-scheme" content="dark light" />
  <style>
    :root{
      --accent:#2563eb;
      --success:#10b981;
      --danger:#ef4444;
      --muted:#6b7280;
      --input-bg:#0f1724;        /* темний фон полів */
      --input-text:#f8fafc;      /* світлий текст у полях */
      --input-placeholder: #94a3b8; /* підказка */
      --card-bg: #ffffff;
    }

    body{font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;}
    .btn{
      position:relative; display:inline-flex; align-items:center; gap:.5rem; padding:.5rem .75rem;
      border-radius:.5rem; background:var(--accent); color:white; font-weight:600; cursor:pointer; user-select:none; overflow:hidden;
      transform:translateZ(0); transition:transform .12s ease, box-shadow .12s ease, opacity .12s ease; box-shadow: 0 6px 18px rgba(37,99,235,0.12);
    }
    .btn:active{ transform: translateY(1px) scale(.995); box-shadow: 0 4px 12px rgba(37,99,235,0.10); }
    .btn.secondary{ background:#374151; box-shadow: 0 6px 18px rgba(15,23,42,0.08); }
    .btn.ghost{ background:transparent; color:var(--accent); border:1px solid rgba(37,99,235,0.12); box-shadow:none; }
    .btn[disabled]{ opacity:.6; pointer-events:none; transform:none; box-shadow:none; }

    .ripple{ position:absolute; border-radius:999px; transform:scale(0); background:rgba(255,255,255,0.25); animation:ripple .6s linear; pointer-events:none; z-index:1; }
    @keyframes ripple{ to { transform: scale(4); opacity: 0; } }

    .badge{ display:inline-flex; align-items:center; gap:.5rem; padding:.25rem .5rem; border-radius:999px; font-weight:600; font-size:13px; }
    .badge.open{ background: rgba(16,185,129,0.08); color: var(--success); border:1px solid rgba(16,185,129,0.12); }
    .badge.closed{ background: rgba(239,68,68,0.06); color: var(--danger); border:1px solid rgba(239,68,68,0.08); }
    .badge.unknown{ background: rgba(148,163,184,0.06); color: var(--muted); border:1px solid rgba(148,163,184,0.06); }

    .status-flash{
      animation: flash 1200ms ease-in-out;
      box-shadow: 0 0 0 3px rgba(99,102,241,0.12), 0 6px 18px rgba(99,102,241,0.08);
    }
    @keyframes flash{
      0%{ box-shadow: 0 0 0 0 rgba(99,102,241,0.18); }
      40%{ box-shadow: 0 0 8px 6px rgba(99,102,241,0.12); }
      100%{ box-shadow: none; }
    }

    .spinner{ width:16px; height:16px; border-radius:50%; border:2px solid rgba(255,255,255,0.25); border-top-color:rgba(255,255,255,0.9); animation:spin .8s linear infinite; }
    .spinner.small{ width:12px; height:12px; border-width:2px; border-top-color:rgba(0,0,0,0.7); border-bottom-color:rgba(0,0,0,0.08); }
    @keyframes spin{ to { transform: rotate(360deg); } }

    input[type="text"], input[type="number"], select, .input-like {
      border-radius:.5rem; padding:.5rem .6rem; border:1px solid rgba(255,255,255,0.06); outline:none;
      background:var(--input-bg); color:var(--input-text); transition:box-shadow .12s ease, border-color .12s ease;
    }
    input::placeholder{ color: var(--input-placeholder); opacity:1; }
    input:focus, select:focus{ box-shadow: 0 6px 18px rgba(37,99,235,0.08); border-color: rgba(99,102,241,0.5); }

    .card{ background:var(--card-bg); }
    .small{ font-size:13px; }
    .live-announcer{ position:absolute; left:-9999px; top:auto; width:1px; height:1px; overflow:hidden; }

    pre{ white-space:pre-wrap; word-break:break-word; font-family:inherit; font-size:13px; color:inherit; }

    /* небольшой косметический темный фон для карточек в темной теме */
    @media (prefers-color-scheme: dark){
      :root{ --card-bg: #0b1220; --input-bg:#0b1220; --input-text:#eef2ff; --input-placeholder:#94a3b8; }
      body{ background:#05060a; color:#e6eef8; }
    }
  </style>
</head>
<body>
  <div class="max-w-6xl mx-auto p-4 sm:p-6">
    <header class="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-3 mb-6">
      <div>
        <h1 class="text-2xl sm:text-3xl font-bold">Перегляд Telegram-каналів — повітряні тривоги</h1>
        <p class="text-sm text-gray-400">Темні поля вводу, кнопки з ripple і індикація відкритості каналу. Дані через RSSHub + ваш Worker.</p>
      </div>
      <div class="text-right text-xs text-gray-400">
        Оновлено: <span id="updated" class="mono">—</span><br />
        Джерело: RSSHub через ваш Worker
      </div>
    </header>

    <section class="mb-4 grid gap-3 sm:grid-cols-2 items-end">
      <div class="flex gap-2 items-center">
        <label class="text-xs text-gray-400">Канал / посилання / ID</label>
        <input id="channelInput" type="text" class="w-[360px]" value="kpszsu" placeholder="kpszsu або https://t.me/kpszsu або 123456789" />
        <button id="loadBtn" class="btn click-anim" aria-live="polite">Завантажити</button>
        <button id="forceBtn" class="btn secondary click-anim">Примусово оновити</button>
        <div class="ml-2 status-row">
          <div id="channelBadge" class="badge unknown">Статус: <span id="statusText" style="margin-left:.5rem">невідомий</span></div>
        </div>
      </div>

      <div class="flex gap-3 items-center justify-end">
        <label class="text-xs text-gray-400">Постів:</label>
        <select id="countSelect" class="px-2 py-2">
          <option value="10">10</option>
          <option value="20" selected>20</option>
          <option value="30">30</option>
          <option value="50">50</option>
        </select>

        <label class="text-xs text-gray-400">Інтервал, сек:</label>
        <input id="intervalInput" type="number" min="10" value="30" class="w-20" />

        <label class="inline-flex items-center gap-2 text-xs text-gray-400">
          <input id="showRawAlways" type="checkbox" checked />
          Показувати сирі пости завжди
        </label>
      </div>
    </section>

    <div id="summary" class="mb-4"></div>

    <div id="out" class="grid gap-4"></div>

    <div id="diag" class="mt-4 text-xs text-red-600"></div>

    <div class="live-announcer" aria-live="polite" id="announcer"></div>

    <footer class="mt-8 text-xs text-gray-400">
      Порада: якщо бачите помилку 429 — збільшіть інтервал опитування до 60+ сек або змініть інстанцію RSSHub у воркері.
    </footer>
  </div>

  <script>
    const WORKER_BASE = "https://dawn-bird-9d4d.nevaznoa855.workers.dev/?channel=";
    const KYIV_TZ = "Europe/Kyiv";

    let POLL_MS = 30000;
    let POLL_TIMER = null;
    let lastStatus = "";

    const loadBtn = document.getElementById("loadBtn");
    const forceBtn = document.getElementById("forceBtn");
    const channelInput = document.getElementById("channelInput");
    const statusText = document.getElementById("statusText");
    const channelBadge = document.getElementById("channelBadge");
    const announcer = document.getElementById("announcer");
    const diag = document.getElementById("diag");

    function nowStr(){ try { return new Date().toLocaleString("uk-UA",{timeZone:KYIV_TZ,hour12:false}); } catch { return new Date().toString(); } }

    function makeRipple(el, x, y){
      const rect = el.getBoundingClientRect();
      const ripple = document.createElement("span");
      ripple.className = "ripple";
      const size = Math.max(rect.width, rect.height) * 0.8;
      ripple.style.width = size + "px";
      ripple.style.height = size + "px";
      ripple.style.left = (x - rect.left - size/2) + "px";
      ripple.style.top = (y - rect.top - size/2) + "px";
      el.appendChild(ripple);
      setTimeout(()=>{ ripple.remove(); }, 700);
    }

    function animateClick(el, ev){
      if(!ev) return;
      makeRipple(el, ev.clientX, ev.clientY);
      el.animate([{ transform: "scale(1)"},{ transform: "scale(.98)"},{ transform: "scale(1)"}], { duration: 140, easing: "ease-out" });
    }

    function flashStatusBadge(){
      channelBadge.classList.add("status-flash");
      setTimeout(()=>channelBadge.classList.remove("status-flash"), 1400);
    }

    function setChannelStatus(open, text){
      const prev = lastStatus;
      if(open){
        channelBadge.classList.remove("closed","unknown");
        channelBadge.classList.add("open");
        statusText.textContent = text || "відкритий";
        announcer.textContent = "Канал відкритий";
        lastStatus = "open";
      } else {
        channelBadge.classList.remove("open","unknown");
        channelBadge.classList.add("closed");
        statusText.textContent = text || "закритий";
        announcer.textContent = "Канал закритий або недоступний для RSSHub";
        lastStatus = "closed";
      }
      if(prev !== lastStatus) flashStatusBadge();
    }

    function normalizeChannelInput(raw){
      if(!raw) return "";
      raw = raw.trim();
      if(raw.startsWith("@")) raw = raw.slice(1);
      try{
        const u = new URL(raw);
        const p = u.pathname.replace(/^\/+|\/+$/g,"");
        if(p.length>0){
          return p.split("/")[0];
        }
        return raw;
      }catch(e){
        return raw;
      }
    }

    function buildWorkerUrl(channel){
      return WORKER_BASE + encodeURIComponent(channel);
    }

    async function fetchFromWorker(channel){
      const url = buildWorkerUrl(channel);
      const r = await fetch(url, { cache: "no-store" });
      if(!r.ok){
        const txt = await r.text().catch(()=>"" );
        throw new Error("HTTP "+r.status + " " + txt.slice(0,200));
      }
      return r.json();
    }

    function findOblastsInText(text){
      if(!text) return [];
      const OBLASTS = ["Вінницька","Волинська","Дніпропетровська","Донецька","Житомирська","Закарпатська","Запорізька","Івано-Франківська","Київська","Кіровоградська","Луганська","Львівська","Миколаївська","Одеська","Полтавська","Рівненська","Сумська","Тернопільська","Харківська","Херсонська","Хмельницька","Черкаська","Чернівецька","Чернігівська","м. Київ","м. Севастополь"];
      const found = new Set();
      const t = (text||"").normalize("NFC");
      for(const o of OBLASTS){
        const re = new RegExp("\\b"+o.replace(/[.*+?^${}()|[\\]\\\\]/g,"\\\\$&")+"\\b","iu");
        if(re.test(t)) found.add(o);
      }
      return Array.from(found);
    }

    function extractSettlements(text){
      if(!text) return [];
      const results = new Set();
      const patterns = [
        /м\.\s*([А-ЯІЇЄҐ][а-яіїєґ'\- ]{1,60})/g,
        /м\s+([А-ЯІЇЄҐ][а-яіїєґ'\- ]{1,60})/g,
        /смт\.?\s*([А-ЯІЇЄҐ][а-яіїєґ'\- ]{1,60})/g,
        /с\.?\s*([А-ЯІЇЄҐ][а-яїєґ'\- ]{1,60})/g
      ];
      for(const p of patterns){
        let m;
        while((m=p.exec(text))!==null){
          const name = (m[1]||"").trim();
          if(name && name.length>1 && name.length<80) results.add(name);
        }
      }
      return Array.from(results);
    }

    function makeTelegramLink(item, channel){
      if(!item) return "https://t.me/" + encodeURIComponent(channel);
      const maybe = item.link || item.url || item.guid || item.id || "";
      if(typeof maybe === "string" && maybe.startsWith("http")) return maybe;
      // fallback to channel link
      return "https://t.me/" + encodeURIComponent(channel);
    }

    function renderResults(groups, posts, channel){
      const out = document.getElementById("out");
      out.innerHTML = "";
      const summary = document.getElementById("summary");
      const regionsCount = Object.keys(groups).length;
      summary.innerHTML = '<div class="flex gap-3 items-center"><div class="inline-flex items-center rounded-full px-3 py-1 bg-red-100 text-red-700"><span class="pulse-dot" style="color:#ef4444"></span>Областей згадано: <strong class="ml-2">'+regionsCount+'</strong></div><div class="text-sm text-gray-400 ml-3">Постів проаналізовано: <strong>'+posts.length+'</strong></div></div>';

      if(Object.keys(groups).length>0){
        for(const oblast of Object.keys(groups).sort((a,b)=>a.localeCompare(b,"uk"))){
          const block = document.createElement("section");
          block.className = "rounded-2xl border border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900 p-4 shadow-sm";
          const header = document.createElement("div");
          header.className = "flex items-center justify-between";
          header.innerHTML = '<h2 class="text-lg font-semibold">'+oblast+'</h2><div class="text-xs text-gray-500">знайдено згадок: <strong>'+groups[oblast].length+'</strong></div>';
          block.appendChild(header);
          const list = document.createElement("ul");
          list.className = "mt-3 space-y-2";
          for(const item of groups[oblast]){
            const li = document.createElement("li");
            li.className = "p-3 rounded-lg bg-gray-50 dark:bg-gray-800";
            const title = document.createElement("div");
            title.className = "text-sm font-medium flex items-center justify-between gap-3";
            const left = document.createElement("div");
            left.innerHTML = (item.title?item.title.replace(/&nbsp;/g," "):"");
            const rightWrap = document.createElement("div");
            rightWrap.className = "flex items-center gap-2";
            const time = document.createElement("div");
            time.className = "text-xs text-gray-500";
            time.textContent = new Date(item.pubDate).toLocaleString("uk-UA",{timeZone:KYIV_TZ,hour12:false});
            const openBtn = document.createElement("a");
            openBtn.className = "btn ghost";
            openBtn.setAttribute("target","_blank");
            openBtn.setAttribute("rel","noopener noreferrer");
            openBtn.href = makeTelegramLink(item, channel);
            openBtn.textContent = "Відкрити в Telegram";
            rightWrap.appendChild(time);
            rightWrap.appendChild(openBtn);
            title.appendChild(left);
            title.appendChild(rightWrap);

            const text = document.createElement("div");
            text.className = "mt-1 text-sm text-gray-700 dark:text-gray-300";
            text.innerHTML = (item.description||"").replace(/<\/?[^>]+(>|$)/g,"");
            const foundSettlements = extractSettlements((item.title||"")+" "+(item.description||""));
            if(foundSettlements.length>0){
              const sdiv = document.createElement("div");
              sdiv.className = "mt-2 text-xs text-gray-600 dark:text-gray-400";
              sdiv.innerHTML = "Виявлені населені пункти: <strong>"+foundSettlements.join(", ")+"</strong>";
              li.appendChild(title);
              li.appendChild(text);
              li.appendChild(sdiv);
            } else {
              li.appendChild(title);
              li.appendChild(text);
            }
            list.appendChild(li);
          }
          block.appendChild(list);
          out.appendChild(block);
        }
      }

      const rawBlock = document.createElement("section");
      rawBlock.className = "rounded-2xl border border-dashed border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900 p-3 mt-4 text-xs text-gray-400";
      rawBlock.innerHTML = "<strong>Сирі останні пости</strong>";
      if(posts.length===0){
        rawBlock.innerHTML += '<div class="mt-3 p-3 rounded bg-gray-50 dark:bg-gray-900 text-sm text-gray-600 dark:text-gray-300">Немає доступних постів або канал не публічний / заблокований для RSSHub.</div>';
      } else {
        for(const p of posts){
          const pdiv = document.createElement("div");
          pdiv.className = "mt-3 p-2 rounded bg-gray-50 dark:bg-gray-900";
          const titleRow = document.createElement("div");
          titleRow.className = "flex items-center justify-between";
          titleRow.innerHTML = '<div class="text-[13px] font-medium">'+(p.title||"")+'</div><div class="text-[12px] text-gray-400">'+new Date(p.pubDate).toLocaleString("uk-UA",{timeZone:KYIV_TZ,hour12:false})+'</div>';
          pdiv.appendChild(titleRow);
          const pre = document.createElement("pre");
          pre.className = "mt-1 text-[13px]";
          pre.textContent = (p.description||"").replace(/<\/?[^>]+(>|$)/g,"");
          pdiv.appendChild(pre);
          const openBtn = document.createElement("a");
          openBtn.className = "btn ghost mt-2";
          openBtn.setAttribute("target","_blank");
          openBtn.setAttribute("rel","noopener noreferrer");
          openBtn.href = makeTelegramLink(p, channel);
          openBtn.textContent = "Відкрити в Telegram";
          pdiv.appendChild(openBtn);
          rawBlock.appendChild(pdiv);
        }
      }
      out.appendChild(rawBlock);
      document.getElementById("updated").textContent = nowStr();
    }

    async function analyze(channel, options = {force:false}){
      try{
        setChannelStatus(false, "перевіряємо...");
        loadBtn.setAttribute("disabled","true");
        forceBtn.setAttribute("disabled","true");
        const start = Date.now();
        const data = await fetchFromWorker(channel);
        const duration = Date.now() - start;
        const items = Array.isArray(data?.items)?data.items:(Array.isArray(data)?data:[]);
        const maxPosts = parseInt(document.getElementById("countSelect").value,10) || 20;
        const posts = [];
        for(const it of items.slice(0, maxPosts)){
          posts.push({ title: it.title||"", description: it.description||it.content||"", pubDate: it.pubDate||it.isoDate||new Date().toISOString(), link: it.link || it.guid || it.url });
        }

        if(items.length>0){
          setChannelStatus(true, "відкритий");
        } else {
          setChannelStatus(false, "закритий");
        }

        const groups = {};
        for(const p of posts){
          const text = (p.title||"")+" "+(p.description||"");
          const oblasts = findOblastsInText(text);
          if(oblasts.length===0) continue;
          for(const o of oblasts){
            if(!groups[o]) groups[o]=[];
            groups[o].push(p);
          }
        }

        renderResults(groups, posts, channel);
        diag.textContent = "Завантажено за "+Math.round(duration/10)/100+" c";
      }catch(e){
        setChannelStatus(false, "недоступний");
        document.getElementById("out").innerHTML = '<div class="p-4 rounded-xl border border-red-300/50 bg-red-50 dark:bg-red-900/20 text-red-700 dark:text-red-200">Не вдалося завантажити дані. Помилка: '+String(e)+'</div>';
        diag.textContent = String(e);
      }finally{
        loadBtn.removeAttribute("disabled");
        forceBtn.removeAttribute("disabled");
      }
    }

    function startPolling(channel){
      if(POLL_TIMER) clearInterval(POLL_TIMER);
      const sec = Math.max(10, parseInt(document.getElementById("intervalInput").value,10) || 30);
      POLL_MS = sec * 1000;
      POLL_TIMER = setInterval(()=>analyze(channel).catch(()=>{}), POLL_MS);
      analyze(channel).catch(()=>{});
      document.getElementById("intervalInput").value = sec;
    }

    loadBtn.addEventListener("click", function(ev){
      animateClick(loadBtn, ev);
      const raw = channelInput.value.trim();
      if(!raw) return alert("Вкажіть канал або ID (наприклад kpszsu або https://t.me/kpszsu).");
      const channel = normalizeChannelInput(raw);
      startPolling(channel);
    });

    forceBtn.addEventListener("click", function(ev){
      animateClick(forceBtn, ev);
      const raw = channelInput.value.trim();
      if(!raw) return;
      const channel = normalizeChannelInput(raw);
      analyze(channel, {force:true}).catch(()=>{});
    });

    channelInput.addEventListener("keyup", function(e){
      if(e.key === "Enter") loadBtn.click();
    });

    document.addEventListener("DOMContentLoaded", function(){
      loadBtn.click();
    });
  </script>
</body>
</html>

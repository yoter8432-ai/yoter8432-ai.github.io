<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Telegram → Повітряні тривоги (стабільніше)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="color-scheme" content="dark light" />
  <style>
    :root{
      --accent:#2563eb;
      --success:#10b981;
      --danger:#ef4444;
      --muted:#6b7280;
      --input-bg:#0f1724;
      --input-text:#f8fafc;
      --input-placeholder: #94a3b8;
      --card-bg: #ffffff;
    }
    body{font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;}
    .btn{ position:relative; display:inline-flex; align-items:center; gap:.5rem; padding:.5rem .75rem; border-radius:.5rem; background:var(--accent); color:white; font-weight:600; cursor:pointer; user-select:none; overflow:hidden; transform:translateZ(0); transition:transform .12s ease, box-shadow .12s ease, opacity .12s ease; box-shadow: 0 6px 18px rgba(37,99,235,0.12); }
    .btn.secondary{ background:#374151; box-shadow: 0 6px 18px rgba(15,23,42,0.08); }
    .btn.ghost{ background:transparent; color:var(--accent); border:1px solid rgba(37,99,235,0.12); box-shadow:none; }
    .btn[disabled]{ opacity:.6; pointer-events:none; transform:none; box-shadow:none; }

    .ripple{ position:absolute; border-radius:999px; transform:scale(0); background:rgba(255,255,255,0.25); animation:ripple .6s linear; pointer-events:none; z-index:1; }
    @keyframes ripple{ to { transform: scale(4); opacity: 0; } }

    .badge{ display:inline-flex; align-items:center; gap:.5rem; padding:.25rem .5rem; border-radius:999px; font-weight:600; font-size:13px; }
    .badge.open{ background: rgba(16,185,129,0.08); color: var(--success); border:1px solid rgba(16,185,129,0.12); }
    .badge.closed{ background: rgba(239,68,68,0.06); color: var(--danger); border:1px solid rgba(239,68,68,0.08); }
    .badge.unknown{ background: rgba(148,163,184,0.06); color: var(--muted); border:1px solid rgba(148,163,184,0.06); }

    .status-flash{ animation: flash 1200ms ease-in-out; box-shadow: 0 0 0 3px rgba(99,102,241,0.12), 0 6px 18px rgba(99,102,241,0.08); }
    @keyframes flash{ 0%{ box-shadow: 0 0 0 0 rgba(99,102,241,0.18); } 40%{ box-shadow: 0 0 8px 6px rgba(99,102,241,0.12); } 100%{ box-shadow: none; } }

    input[type="text"], input[type="number"], select, .input-like { border-radius:.5rem; padding:.5rem .6rem; border:1px solid rgba(255,255,255,0.06); outline:none; background:var(--input-bg); color:var(--input-text); transition:box-shadow .12s ease, border-color .12s ease; }
    input::placeholder{ color: var(--input-placeholder); opacity:1; }
    input:focus, select:focus{ box-shadow: 0 6px 18px rgba(37,99,235,0.08); border-color: rgba(99,102,241,0.5); }

    .card{ background:var(--card-bg); }
    .small{ font-size:13px; }
    .live-announcer{ position:absolute; left:-9999px; top:auto; width:1px; height:1px; overflow:hidden; }

    pre{ white-space:pre-wrap; word-break:break-word; font-family:inherit; font-size:13px; color:inherit; }

    @media (prefers-color-scheme: dark){
      :root{ --card-bg: #0b1220; --input-bg:#0b1220; --input-text:#eef2ff; --input-placeholder:#94a3b8; }
      body{ background:#05060a; color:#e6eef8; }
    }
  </style>
</head>
<body>
  <div class="max-w-6xl mx-auto p-4 sm:p-6">
    <header class="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-3 mb-6">
      <div>
        <h1 class="text-2xl sm:text-3xl font-bold">Telegram → Повітряні тривоги (стабільний режим)</h1>
        <p class="text-sm text-gray-400">Тепер збереженням останніх постів, захистом від короткочасних пустих відповідей і автоматичним backoff.</p>
      </div>
      <div class="text-right text-xs text-gray-400">Оновлено: <span id="updated" class="mono">—</span><br />Джерело: RSSHub через ваш Worker</div>
    </header>

    <section class="mb-4 grid gap-3 sm:grid-cols-2 items-end">
      <div class="flex gap-2 items-center">
        <label class="text-xs text-gray-400">Канал / посилання / ID</label>
        <input id="channelInput" type="text" class="w-[360px]" value="kpszsu" placeholder="kpszsu або https://t.me/kpszsu або 123456789" />
        <button id="loadBtn" class="btn">Завантажити</button>
        <button id="forceBtn" class="btn secondary">Примусово оновити</button>
        <div class="ml-2 status-row">
          <div id="channelBadge" class="badge unknown">Статус: <span id="statusText" style="margin-left:.5rem">—</span></div>
        </div>
      </div>

      <div class="flex gap-3 items-center justify-end">
        <label class="text-xs text-gray-400">Постів:</label>
        <select id="countSelect" class="px-2 py-2">
          <option value="10">10</option>
          <option value="20" selected>20</option>
          <option value="30">30</option>
          <option value="50">50</option>
        </select>

        <label class="text-xs text-gray-400">Інтервал, сек:</label>
        <input id="intervalInput" type="number" min="10" value="30" class="w-20" />

        <label class="inline-flex items-center gap-2 text-xs text-gray-400">
          <input id="showRawAlways" type="checkbox" checked />
          Показувати сирі пости завжди
        </label>
      </div>
    </section>

    <div id="summary" class="mb-4"></div>
    <div id="out" class="grid gap-4"></div>
    <div id="diag" class="mt-4 text-xs text-red-600"></div>
    <div class="live-announcer" aria-live="polite" id="announcer"></div>

    <footer class="mt-8 text-xs text-gray-400">Порада: якщо бачите 429 — збільште інтервал до 60+ сек або змініть інстанцію RSSHub у воркері.</footer>
  </div>

  <script>
    const WORKER_BASE = "https://dawn-bird-9d4d.nevaznoa855.workers.dev/?channel=";
    const KYIV_TZ = "Europe/Kyiv";

    const EMPTY_THRESHOLD = 2;
    const MAX_BACKOFF_MS = 300000;
    const INITIAL_POLL_MS = 30000;

    let POLL_MS = INITIAL_POLL_MS;
    let POLL_TIMER = null;
    let consecutiveEmpty = parseInt(localStorage.getItem("consecutiveEmpty")||"0",10);
    let backoffMs = parseInt(localStorage.getItem("backoffMs")||"0",10) || 0;

    const loadBtn = document.getElementById("loadBtn");
    const forceBtn = document.getElementById("forceBtn");
    const channelInput = document.getElementById("channelInput");
    const statusText = document.getElementById("statusText");
    const channelBadge = document.getElementById("channelBadge");
    const announcer = document.getElementById("announcer");
    const diag = document.getElementById("diag");

    function nowStr(){ try { return new Date().toLocaleString("uk-UA",{timeZone:KYIV_TZ,hour12:false}); } catch { return new Date().toString(); } }

    function normalizeChannelInput(raw){
      if(!raw) return "";
      raw = raw.trim();
      if(raw.startsWith("@")) raw = raw.slice(1);
      try{
        const u = new URL(raw);
        const p = u.pathname.replace(/^\/+|\/+$/g,"");
        if(p.length>0){
          return p.split("/")[0];
        }
        return raw;
      }catch(e){
        return raw;
      }
    }

    function buildWorkerUrl(channel){
      return WORKER_BASE + encodeURIComponent(channel);
    }

    async function fetchFromWorker(channel){
      const url = buildWorkerUrl(channel);
      const r = await fetch(url, { cache: "no-store" });
      if(!r.ok){
        const txt = await r.text().catch(()=>"" );
        throw new Error("HTTP "+r.status + " " + txt.slice(0,200));
      }
      return r.json();
    }

    function setChannelStatus(open, text, silent=false){
      const prev = localStorage.getItem("lastStatus") || "unknown";
      if(open){
        channelBadge.classList.remove("closed","unknown");
        channelBadge.classList.add("open");
        statusText.textContent = text || "відкритий";
        announcer.textContent = "Канал відкритий";
        localStorage.setItem("lastStatus","open");
      } else {
        channelBadge.classList.remove("open","unknown");
        channelBadge.classList.add("closed");
        statusText.textContent = text || "закритий";
        announcer.textContent = "Канал закритий або недоступний для RSSHub";
        localStorage.setItem("lastStatus","closed");
      }
      if(!silent && prev !== localStorage.getItem("lastStatus")){
        channelBadge.classList.add("status-flash");
        setTimeout(()=>channelBadge.classList.remove("status-flash"),1400);
      }
    }

    function saveSuccessfulPosts(posts){
      try{
        localStorage.setItem("lastPosts", JSON.stringify(posts));
        localStorage.setItem("lastFetchedAt", new Date().toISOString());
        localStorage.setItem("consecutiveEmpty", "0");
        consecutiveEmpty = 0;
      }catch(e){}
    }

    function loadSavedPosts(){
      try{
        const raw = localStorage.getItem("lastPosts");
        if(!raw) return null;
        return JSON.parse(raw);
      }catch{return null}
    }

    function getSavedFetchedAt(){
      return localStorage.getItem("lastFetchedAt") || null;
    }

    function increaseBackoff(){
      backoffMs = Math.max(1000, backoffMs? backoffMs*2 : 5000);
      backoffMs = Math.min(backoffMs, MAX_BACKOFF_MS);
      localStorage.setItem("backoffMs", String(backoffMs));
    }

    function resetBackoff(){
      backoffMs = 0;
      localStorage.removeItem("backoffMs");
    }

    function getStaleAge(){
      const at = getSavedFetchedAt();
      if(!at) return null;
      const d = new Date(at);
      const diff = Math.floor((Date.now() - d.getTime())/1000);
      if(diff < 60) return diff + " c";
      if(diff < 3600) return Math.floor(diff/60) + " хв";
      return Math.floor(diff/3600) + " год";
    }

    function renderResults(groups, posts, channel, isStale=false){
      const out = document.getElementById("out");
      out.innerHTML = "";
      const summary = document.getElementById("summary");
      const regionsCount = Object.keys(groups).length;
      const staleLabel = isStale ? (' <span class="text-xs text-yellow-500">(застаріло: '+(getStaleAge()||"невідомо")+')</span>') : "";
      summary.innerHTML = '<div class="flex gap-3 items-center"><div class="inline-flex items-center rounded-full px-3 py-1 bg-red-100 text-red-700"><span class="pulse-dot" style="color:#ef4444"></span>Областей згадано: <strong class="ml-2">'+regionsCount+'</strong></div><div class="text-sm text-gray-400 ml-3">Постів проаналізовано: <strong>'+posts.length+'</strong>'+staleLabel+'</div></div>';

      if(Object.keys(groups).length>0){
        for(const oblast of Object.keys(groups).sort((a,b)=>a.localeCompare(b,"uk"))){
          const block = document.createElement("section");
          block.className = "rounded-2xl border border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900 p-4 shadow-sm";
          const header = document.createElement("div");
          header.className = "flex items-center justify-between";
          header.innerHTML = '<h2 class="text-lg font-semibold">'+oblast+'</h2><div class="text-xs text-gray-500">знайдено згадок: <strong>'+groups[oblast].length+'</strong></div>';
          block.appendChild(header);
          const list = document.createElement("ul");
          list.className = "mt-3 space-y-2";
          for(const item of groups[oblast]){
            const li = document.createElement("li");
            li.className = "p-3 rounded-lg bg-gray-50 dark:bg-gray-800";
            const title = document.createElement("div");
            title.className = "text-sm font-medium flex items-center justify-between gap-3";
            const left = document.createElement("div");
            left.innerHTML = (item.title?item.title.replace(/&nbsp;/g," "):"");
            const rightWrap = document.createElement("div");
            rightWrap.className = "flex items-center gap-2";
            const time = document.createElement("div");
            time.className = "text-xs text-gray-500";
            time.textContent = new Date(item.pubDate).toLocaleString("uk-UA",{timeZone:KYIV_TZ,hour12:false});
            const openBtn = document.createElement("a");
            openBtn.className = "btn ghost";
            openBtn.setAttribute("target","_blank");
            openBtn.setAttribute("rel","noopener noreferrer");
            openBtn.href = item.link || ("https://t.me/"+encodeURIComponent(channel));
            openBtn.textContent = "Відкрити в Telegram";
            rightWrap.appendChild(time);
            rightWrap.appendChild(openBtn);
            title.appendChild(left);
            title.appendChild(rightWrap);

            const text = document.createElement("div");
            text.className = "mt-1 text-sm text-gray-700 dark:text-gray-300";
            text.innerHTML = (item.description||"").replace(/<\/?[^>]+(>|$)/g,"");
            const foundSettlements = (function(t){
              const results = new Set();
              const patterns = [/м\.\s*([А-ЯІЇЄҐ][а-яіїєґ'\- ]{1,60})/g,/м\s+([А-ЯІЇЄҐ][а-яіїєґ'\- ]{1,60})/g,/смт\.?\s*([А-ЯІЇЄҐ][а-яіїєґ'\- ]{1,60})/g,/с\.?\s*([А-ЯІЇЄҐ][а-яїєґ'\- ]{1,60})/g];
              for(const p of patterns){ let m; while((m=p.exec(t||""))!==null){ const name=(m[1]||"").trim(); if(name && name.length>1 && name.length<80) results.add(name); } }
              return Array.from(results);
            })((item.title||"")+" "+(item.description||""));
            if(foundSettlements.length>0){
              const sdiv = document.createElement("div");
              sdiv.className = "mt-2 text-xs text-gray-600 dark:text-gray-400";
              sdiv.innerHTML = "Виявлені населені пункти: <strong>"+foundSettlements.join(", ")+"</strong>";
              li.appendChild(title);
              li.appendChild(text);
              li.appendChild(sdiv);
            } else {
              li.appendChild(title);
              li.appendChild(text);
            }
            list.appendChild(li);
          }
          block.appendChild(list);
          out.appendChild(block);
        }
      }

      const rawBlock = document.createElement("section");
      rawBlock.className = "rounded-2xl border border-dashed border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900 p-3 mt-4 text-xs text-gray-400";
      rawBlock.innerHTML = "<strong>Сирі останні пости</strong>";
      if(posts.length===0){
        rawBlock.innerHTML += '<div class="mt-3 p-3 rounded bg-gray-50 dark:bg-gray-900 text-sm text-gray-600 dark:text-gray-300">Немає доступних постів або канал не публічний / заблокований для RSSHub.</div>';
      } else {
        for(const p of posts){
          const pdiv = document.createElement("div");
          pdiv.className = "mt-3 p-2 rounded bg-gray-50 dark:bg-gray-900";
          const titleRow = document.createElement("div");
          titleRow.className = "flex items-center justify-between";
          titleRow.innerHTML = '<div class="text-[13px] font-medium">'+(p.title||"")+'</div><div class="text-[12px] text-gray-400">'+new Date(p.pubDate).toLocaleString("uk-UA",{timeZone:KYIV_TZ,hour12:false})+'</div>';
          pdiv.appendChild(titleRow);
          const pre = document.createElement("pre");
          pre.className = "mt-1 text-[13px]";
          pre.textContent = (p.description||"").replace(/<\/?[^>]+(>|$)/g,"");
          pdiv.appendChild(pre);
          const openBtn = document.createElement("a");
          openBtn.className = "btn ghost mt-2";
          openBtn.setAttribute("target","_blank");
          openBtn.setAttribute("rel","noopener noreferrer");
          openBtn.href = p.link || ("https://t.me/"+encodeURIComponent(channel));
          openBtn.textContent = "Відкрити в Telegram";
          pdiv.appendChild(openBtn);
          rawBlock.appendChild(pdiv);
        }
      }
      out.appendChild(rawBlock);
      document.getElementById("updated").textContent = nowStr();
    }

    async function analyze(channel, options = {force:false}){
      try{
        setChannelStatus(false, "перевіряємо...", true);
        loadBtn.setAttribute("disabled","true");
        forceBtn.setAttribute("disabled","true");
        diag.textContent = "";

        if(backoffMs > 0 && !options.force){
          diag.textContent = "Backoff активний: чекати " + Math.round(backoffMs/1000) + " c";
          await new Promise(r=>setTimeout(r, backoffMs));
        }

        const start = Date.now();
        const data = await fetchFromWorker(channel);
        const took = Date.now() - start;

        const items = Array.isArray(data?.items) ? data.items : (Array.isArray(data) ? data : (Array.isArray(data?.rss?.channel?.item) ? data.rss.channel.item : []));
        const maxPosts = parseInt(document.getElementById("countSelect").value,10) || 20;

        if(items && items.length > 0){
          const posts = items.slice(0, maxPosts).map(it => ({ title: it.title||"", description: it.description||it.content||"", pubDate: it.pubDate||it.isoDate||new Date().toISOString(), link: it.link || it.guid || it.url || "" }));
          saveSuccessfulPosts(posts);
          resetBackoff();
          consecutiveEmpty = 0;
          localStorage.setItem("consecutiveEmpty", "0");
          setChannelStatus(true, "відкритий");
          const groups = {};
          for(const p of posts){
            const text = (p.title||"")+" "+(p.description||"");
            const oblasts = (function(t){ const O=["Вінницька","Волинська","Дніпропетровська","Донецька","Житомирська","Закарпатська","Запорізька","Івано-Франківська","Київська","Кіровоградська","Луганська","Львівська","Миколаївська","Одеська","Полтавська","Рівненська","Сумська","Тернопільська","Харківська","Херсонська","Хмельницька","Черкаська","Чернівецька","Чернігівська","м. Київ","м. Севастополь"]; const found=new Set(); for(const o of O){ const re=new RegExp("\\b"+o.replace(/[.*+?^${}()|[\\]\\\\]/g,"\\\\$&")+"\\b","iu"); if(re.test(t)) found.add(o);} return Array.from(found); })(text);
            for(const o of oblasts){ if(!groups[o]) groups[o]=[]; groups[o].push(p); }
          }
          renderResults(groups, posts, channel, false);
          diag.textContent = "Оновлено за "+Math.round(took/10)/100+" c";
        } else {
          consecutiveEmpty = (parseInt(localStorage.getItem("consecutiveEmpty")||"0",10) || 0) + 1;
          localStorage.setItem("consecutiveEmpty", String(consecutiveEmpty));
          const savedPosts = loadSavedPosts();
          if(savedPosts && savedPosts.length>0){
            setChannelStatus(false, "тимчасово недоступний", true);
            const groups = {};
            for(const p of savedPosts){
              const text = (p.title||"")+" "+(p.description||"");
              const oblasts = (function(t){ const O=["Вінницька","Волинська","Дніпропетровська","Донецька","Житомирська","Закарпатська","Запорізька","Івано-Франківська","Київська","Кіровоградська","Луганська","Львівська","Миколаївська","Одеська","Полтавська","Рівненська","Сумська","Тернопільська","Харківська","Херсонська","Хмельницька","Черкаська","Чернівецька","Чернігівська","м. Київ","м. Севастополь"]; const found=new Set(); for(const o of O){ const re=new RegExp("\\b"+o.replace(/[.*+?^${}()|[\\]\\\\]/g,"\\\\$&")+"\\b","iu"); if(re.test(t)) found.add(o);} return Array.from(found); })(text);
              for(const o of oblasts){ if(!groups[o]) groups[o]=[]; groups[o].push(p); }
            }
            const isStale = true;
            renderResults(groups, savedPosts, channel, isStale);
            diag.textContent = "Отримано порожню відповідь від RSSHub. Показуються останні відомі пости. Порожніх відповідей поспіль: " + consecutiveEmpty;
            if(consecutiveEmpty >= EMPTY_THRESHOLD){
              setChannelStatus(false, "закритий", false);
            }
          } else {
            setChannelStatus(false, "закритий", false);
            renderResults({}, [], channel, false);
            diag.textContent = "Канал не повернув пости і збережених постів немає. Порожніх відповідей поспіль: " + consecutiveEmpty;
          }
          increaseBackoff();
        }
      }catch(e){
        increaseBackoff();
        setChannelStatus(false, "недоступний", true);
        const savedPosts = loadSavedPosts() || [];
        if(savedPosts.length>0){
          renderResults({}, savedPosts, normalizeChannelInput(channelInput.value||""), true);
          diag.textContent = "Помилка мережі/серверу: " + String(e) + ". Показуються збережені пости. Backoff: " + Math.round(backoffMs/1000) + " c";
        } else {
          document.getElementById("out").innerHTML = '<div class="p-4 rounded-xl border border-red-300/50 bg-red-50 dark:bg-red-900/20 text-red-700 dark:text-red-200">Не вдалося завантажити дані. Помилка: '+String(e)+'</div>';
          diag.textContent = String(e);
        }
      }finally{
        loadBtn.removeAttribute("disabled");
        forceBtn.removeAttribute("disabled");
      }
    }

    function startPolling(channel){
      if(POLL_TIMER) clearInterval(POLL_TIMER);
      const sec = Math.max(10, parseInt(document.getElementById("intervalInput").value,10) || 30);
      POLL_MS = sec * 1000;
      const effectiveInterval = Math.max(POLL_MS, backoffMs || 0) || POLL_MS;
      POLL_TIMER = setInterval(()=>analyze(channel).catch(()=>{}), effectiveInterval);
      analyze(channel).catch(()=>{});
      document.getElementById("intervalInput").value = sec;
    }

    loadBtn.addEventListener("click", function(){
      const raw = channelInput.value.trim();
      if(!raw) return alert("Вкажіть канал або ID (наприклад kpszsu або https://t.me/kpszsu).");
      const channel = normalizeChannelInput(raw);
      startPolling(channel);
    });

    forceBtn.addEventListener("click", function(){
      const raw = channelInput.value.trim();
      if(!raw) return;
      const channel = normalizeChannelInput(raw);
      backoffMs = 0;
      localStorage.removeItem("backoffMs");
      analyze(channel, {force:true}).catch(()=>{});
    });

    channelInput.addEventListener("keyup", function(e){
      if(e.key === "Enter") loadBtn.click();
    });

    document.addEventListener("DOMContentLoaded", function(){
      const saved = localStorage.getItem("lastChannel");
      if(saved) channelInput.value = saved;
      const initial = normalizeChannelInput(channelInput.value||"kpszsu");
      if(initial) startPolling(initial);
    });

    function increaseBackoff(){
      backoffMs = backoffMs ? Math.min(backoffMs*2, MAX_BACKOFF_MS) : 5000;
      localStorage.setItem("backoffMs", String(backoffMs));
    }
    function resetBackoff(){ backoffMs = 0; localStorage.removeItem("backoffMs"); }

    window.addEventListener("beforeunload", function(){
      try{ localStorage.setItem("lastChannel", normalizeChannelInput(channelInput.value||"")); }catch(e){}
    });
  </script>
</body>
</html>

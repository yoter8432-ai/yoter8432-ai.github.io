<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Telegram — Повітряні тривоги (тільки сьогодні)</title>
  <meta name="color-scheme" content="light dark" />
  <style>
    :root{
      --accent: #2563eb;
      --success: #059669;
      --danger: #dc2626;
      --muted: #6b7280;
      --bg: #f8fafc;
      --card-bg: #ffffff;
      --card-border: #e6edf6;
      --text: #0f1724;
      --muted-text: #475569;
      --pill-bg: rgba(37,99,235,0.08);
      --new-bg: #fff7ed;
      --new-border: #f59e0b;
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg: #030312;
        --card-bg: #071226;
        --card-border: #0b2236;
        --text: #e6eef8;
        --muted-text: #9aa8bf;
        --pill-bg: rgba(37,99,235,0.12);
        --new-bg: #2b1b05;
        --new-border: #f59e0b;
      }
    }
    body{ margin:0; font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background: var(--bg); color: var(--text); -webkit-font-smoothing:antialiased; }
    .container{ max-width:1100px; margin:28px auto; padding:18px; }
    header{ display:flex; gap:12px; align-items:flex-end; }
    h1{ margin:0; font-size:20px; font-weight:700; }
    .muted{ color:var(--muted-text); font-size:13px; }
    .controls{ margin-top:14px; display:flex; gap:10px; align-items:center; flex-wrap:wrap; background:var(--card-bg); border:1px solid var(--card-border); padding:12px; border-radius:12px; box-shadow: 0 6px 20px rgba(2,6,23,0.04); }
    .controls label{ font-size:13px; color:var(--muted-text); }
    input[type="text"], input[type="number"], select { border-radius:8px; padding:8px 10px; border:1px solid var(--card-border); background:transparent; color:var(--text); min-height:38px; }
    input::placeholder{ color:#9aa8bf; }
    .btn{ display:inline-flex; gap:8px; align-items:center; padding:8px 12px; border-radius:10px; cursor:pointer; border:0; background:var(--accent); color:white; font-weight:600; box-shadow:0 6px 18px rgba(37,99,235,0.12); }
    .btn.secondary{ background:#374151; box-shadow:none; color:white; }
    .btn.ghost{ background:transparent; color:var(--accent); border:1px solid rgba(37,99,235,0.12); }
    .btn[disabled]{ opacity:.6; pointer-events:none; }
    .badge{ display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; background:var(--pill-bg); color:var(--accent); font-weight:700; font-size:13px; }
    .status { display:flex; gap:10px; align-items:center; margin-top:12px; }
    #diag { color:var(--danger); font-size:13px; }
    #summary { margin-top:16px; display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .summary-pill{ background:var(--card-bg); border:1px solid var(--card-border); padding:8px 12px; border-radius:10px; font-weight:700; color:var(--text); display:inline-flex; gap:8px; align-items:center; }
    .region-card { background:var(--card-bg); border:1px solid var(--card-border); border-radius:12px; padding:12px; margin-top:12px; }
    .region-header { display:flex; justify-content:space-between; gap:10px; align-items:center; }
    .region-title{ font-weight:700; font-size:16px; }
    .region-meta{ color:var(--muted-text); font-size:13px; }
    .post{ border-radius:10px; padding:10px; margin-top:10px; border:1px solid rgba(0,0,0,0.02); display:flex; flex-direction:column; gap:8px; background:transparent; }
    .post .top{ display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .post .title{ font-weight:700; font-size:15px; color:var(--text); }
    .post .time{ color:var(--muted-text); font-size:13px; min-width:110px; text-align:right; }
    .post .body{ color:var(--muted-text); font-size:14px; white-space:pre-wrap; }
    .post .actions{ display:flex; gap:8px; align-items:center; margin-top:6px; }
    .post a.open{ background:transparent; border:1px solid var(--card-border); color:var(--accent); padding:6px 10px; border-radius:8px; text-decoration:none; font-weight:600; }
    .raw-block { margin-top:16px; border-radius:10px; background:var(--card-bg); border:1px dashed var(--card-border); padding:12px; color:var(--muted-text); font-size:13px; }
    .post.new { background: var(--new-bg); border:2px solid var(--new-border); box-shadow: 0 8px 20px rgba(245,158,11,0.06); animation: newFlash 2.2s ease; }
    @keyframes newFlash { 0% { transform: translateY(-6px); } 40% { transform: translateY(0); } 100% { transform: translateY(0); } }
    .pill-new { font-size:12px; padding:4px 8px; background:var(--new-border); color:white; border-radius:999px; font-weight:700; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace; font-size:13px; color:var(--muted-text); }
    .small{ font-size:13px; color:var(--muted-text); }
    @media (max-width:800px){ .controls{ flex-direction:column; align-items:stretch; } input[type="text"]{ width:100%; } }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>Telegram — Повітряні тривоги (тільки сьогодні)</h1>
        <div class="muted">Дані через RSSHub / Cloudflare Worker. Показувати лише пости сьогоднішнього дня (Kyiv time). Нові пости зверху.</div>
      </div>
      <div style="margin-left:auto; text-align:right;">
        <div class="mono">Оновлено: <span id="updated">—</span></div>
        <div class="small">Worker: <span id="workerHost">dawn-bird-9d4d.nevaznoa855.workers.dev</span></div>
      </div>
    </header>

    <div class="controls" role="region" aria-label="Налаштування">
      <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
        <label class="small" for="channelInput">Канал</label>
        <input id="channelInput" type="text" value="kpszsu" placeholder="kpszsu або https://t.me/kpszsu або ID" />
        <button id="loadBtn" class="btn">Завантажити</button>
        <button id="forceBtn" class="btn secondary">Примусово оновити</button>
        <button id="resetBackoffBtn" class="btn ghost" title="Скидає backoff і негайно перезапитує">Скинути backoff</button>
      </div>

      <div style="margin-left:auto; display:flex; gap:10px; align-items:center;">
        <label class="small" for="countSelect">Постів</label>
        <select id="countSelect"><option value="10">10</option><option value="20" selected>20</option><option value="30">30</option><option value="50">50</option></select>

        <label class="small" for="intervalInput">Інтервал (c)</label>
        <input id="intervalInput" type="number" min="10" value="30" style="width:80px" />

        <label style="display:flex; gap:6px; align-items:center;"><input id="showRawAlways" type="checkbox" checked /> <span class="small">Показувати сирі пости</span></label>
      </div>
    </div>

    <div class="status">
      <div id="channelBadge" class="badge">Статус: <span id="statusText" style="margin-left:6px">—</span></div>
      <div id="diag" style="margin-left:6px"></div>
    </div>

    <div id="summary">
      <div id="oblastsPill" class="summary-pill">Областей згадано: <strong id="oblastsCount">0</strong></div>
      <div id="citiesPill" class="summary-pill">Міст згадано: <strong id="citiesCount">0</strong></div>
      <div id="citiesList" style="margin-left:6px; color:var(--muted-text); font-size:13px"></div>
    </div>

    <div id="out"></div>

    <div id="raw" class="raw-block" style="display:none;"></div>
  </div>

  <script>
    const WORKER_BASE = "https://dawn-bird-9d4d.nevaznoa855.workers.dev/?channel=";
    const KYIV_TZ = "Europe/Kyiv";
    const EMPTY_THRESHOLD = 2;
    const MAX_BACKOFF_MS = 300000;

    let backoffMs = parseInt(localStorage.getItem("backoffMs")||"0",10) || 0;
    let consecutiveEmpty = parseInt(localStorage.getItem("consecutiveEmpty")||"0",10) || 0;
    let POLL_TIMER = null;

    const channelInput = document.getElementById("channelInput");
    const loadBtn = document.getElementById("loadBtn");
    const forceBtn = document.getElementById("forceBtn");
    const resetBackoffBtn = document.getElementById("resetBackoffBtn");
    const countSelect = document.getElementById("countSelect");
    const intervalInput = document.getElementById("intervalInput");
    const showRawAlways = document.getElementById("showRawAlways");
    const out = document.getElementById("out");
    const rawBlock = document.getElementById("raw");
    const statusText = document.getElementById("statusText");
    const channelBadge = document.getElementById("channelBadge");
    const diag = document.getElementById("diag");
    const oblastsCountEl = document.getElementById("oblastsCount");
    const citiesCountEl = document.getElementById("citiesCount");
    const citiesListEl = document.getElementById("citiesList");
    document.getElementById("workerHost").textContent = new URL(WORKER_BASE).host;

    function nowStr(){ try { return new Date().toLocaleString("uk-UA",{timeZone:KYIV_TZ,hour12:false}); } catch(e){ return new Date().toString(); } }
    function normalizeChannelInput(raw){ if(!raw) return ""; raw=raw.trim(); if(raw.startsWith("@")) raw=raw.slice(1); try{ const u=new URL(raw); const p=u.pathname.replace(/^\/+|\/+$/g,""); if(p.length>0) return p.split("/")[0]; return raw; }catch(e){ return raw; } }
    function buildWorkerUrl(channel, extra){ const e = extra ? "&"+extra.replace(/^[&?]+/,"") : ""; return WORKER_BASE + encodeURIComponent(channel) + e; }
    async function fetchFromWorker(channel, extra){ const url = buildWorkerUrl(channel, extra); const r = await fetch(url, { cache: "no-store" }); if(!r.ok){ const txt = await r.text().catch(()=> ""); throw new Error("HTTP "+r.status + " " + (txt.slice? txt.slice(0,400) : String(txt))); } return r.json(); }

    function getKyivDateString(ms){
      try{
        const d = new Date(ms);
        return new Intl.DateTimeFormat("en-CA", { timeZone: KYIV_TZ }).format(d);
      }catch(e){ return ""; }
    }
    function parseDateToMillis(pubDate){
      if(!pubDate) return 0;
      const d = Date.parse(pubDate);
      if(!isNaN(d)) return d;
      const timeOnly = pubDate.trim().match(/^\d{1,2}:\d{2}$/);
      if(timeOnly){
        const now = new Date();
        const [hh,mm] = pubDate.split(":").map(Number);
        const dd = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hh, mm);
        return dd.getTime();
      }
      return 0;
    }
    function formatKyiv(pubDate){
      try{ const d = new Date(pubDate); if(isNaN(d)) return pubDate || ""; return d.toLocaleString("uk-UA",{timeZone:KYIV_TZ, hour12:false, year:"numeric", month:"2-digit", day:"2-digit", hour:"2-digit", minute:"2-digit"}); }catch(e){ return pubDate||""; }

    const oblastPairs = [
      { oblast: "Вінницька", noun: "Вінниця" },
      { oblast: "Волинська", noun: "Волинь" },
      { oblast: "Дніпропетровська", noun: "Дніпро" },
      { oblast: "Донецька", noun: "Донецьк" },
      { oblast: "Житомирська", noun: "Житомир" },
      { oblast: "Закарпатська", noun: "Закарпаття" },
      { oblast: "Запорізька", noun: "Запоріжжя" },
      { oblast: "Івано-Франківська", noun: "Івано-Франківськ" },
      { oblast: "Київська", noun: "Київська" },
      { oblast: "Кіровоградська", noun: "Кропивницький" },
      { oblast: "Луганська", noun: "Луганськ" },
      { oblast: "Львівська", noun: "Львів" },
      { oblast: "Миколаївська", noun: "Миколаїв" },
      { oblast: "Одеська", noun: "Одеса" },
      { oblast: "Полтавська", noun: "Полтава" },
      { oblast: "Рівненська", noun: "Рівне" },
      { oblast: "Сумська", noun: "Суми" },
      { oblast: "Тернопільська", noun: "Тернопіль" },
      { oblast: "Харківська", noun: "Харків" },
      { oblast: "Херсонська", noun: "Херсон" },
      { oblast: "Хмельницька", noun: "Хмельницький" },
      { oblast: "Черкаська", noun: "Черкаси" },
      { oblast: "Чернівецька", noun: "Чернівці" },
      { oblast: "Чернігівська", noun: "Чернігів" },
      { oblast: "м. Київ", noun: "Київ" },
      { oblast: "м. Севастополь", noun: "Севастополь" }
    ];

    function escapeRegex(s){ return s.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"); }
    function capitalizeUkr(s){ return s.replace(/\s+/g," ").replace(/(^|\s)([а-яіїєґA-ЯІЇЄҐ])/gu, (m, a, b)=> a + b.toUpperCase()); }
    function validCityName(name){ if(!name) return false; if(name.length < 3) return false; const stop = ["область","області","областю","район","району","місто","міст","село","смт","курсом","півночі","півдні","захід","схід"]; const lower = name.toLowerCase(); for(const s of stop) if(lower.indexOf(s) !== -1) return false; return true; }

    function extractOblastsFromText(text){
      const found = new Set();
      if(!text) return [];
      for(const p of oblastPairs){
        const parts = [];
        parts.push(p.oblast);
        parts.push(p.noun);
        const alt = p.noun.replace(/(ь|а|я|й|о|и|і)$/iu, "");
        parts.push(alt);
        const re = new RegExp("\\b(?:" + parts.map(s=>escapeRegex(s)).join("|") + ")\\b", "iu");
        if(re.test(text)) found.add(p.oblast);
      }
      return Array.from(found);
    }

    function extractCitiesFromText(text){
      const cities = [];
      if(!text) return cities;
      const explicit = new RegExp("\\b(?:м\\.|м|місто|смт|с\\.|селище)\\s*([А-ЯІЇЄҐ][а-яіїєґ'\\-\\s]{1,60})","giu");
      let m;
      while((m = explicit.exec(text)) !== null){
        const name = m[1].trim().replace(/\s+/g," ");
        if(validCityName(name)) cities.push(capitalizeUkr(name));
      }
      const prep = new RegExp("\\b(?:в|у|на|біля|поблизу|околицях|районі|р-ні|район)\\s+([А-ЯІЇЄҐ][а-яіїєґ'\\-\\s]{2,60})","giu");
      while((m = prep.exec(text)) !== null){
        const name = m[1].trim().replace(/[.,:;!?)]+$/,"").replace(/\s+/g," ");
        if(validCityName(name)) cities.push(capitalizeUkr(name));
      }
      const afterColon = new RegExp("([А-ЯІЇЄҐ][а-яіїєґ'\\-\\s]{2,60})\\s*-\\s*(?:в|у|на)","giu");
      while((m = afterColon.exec(text)) !== null){
        const name = m[1].trim().replace(/\s+/g," ");
        if(validCityName(name)) cities.push(capitalizeUkr(name));
      }
      const uniq = Array.from(new Set(cities));
      return uniq;
    }

    function loadLastPosts(){ try{ const s = localStorage.getItem("lastPosts"); return s ? JSON.parse(s) : null; }catch(e){ return null; } }
    function saveLastPosts(posts){
      try{
        const todayStr = getKyivDateString(Date.now());
        const onlyToday = (posts||[]).filter(p=> p.dateKyiv === todayStr);
        localStorage.setItem("lastPosts", JSON.stringify(onlyToday));
        localStorage.setItem("lastFetchedAt", new Date().toISOString());
        localStorage.setItem("consecutiveEmpty","0");
        consecutiveEmpty = 0;
      }catch(e){}
    }
    function getKyivDateString(ms){ try{ const d = new Date(ms); return new Intl.DateTimeFormat("en-CA", { timeZone: KYIV_TZ }).format(d); }catch(e){ return ""; } }

    function setChannelStatus(open, text, silent=false){
      if(open){ channelBadge.classList.remove("closed"); channelBadge.classList.add("badge"); statusText.textContent = text || "відкритий"; localStorage.setItem("lastStatus","open"); } else { channelBadge.classList.add("closed"); statusText.textContent = text || "закритий"; localStorage.setItem("lastStatus","closed"); }
      if(!silent){ channelBadge.classList.add("status-flash"); setTimeout(()=>channelBadge.classList.remove("status-flash"), 1200); }
    }

    async function analyze(channel, options={force:false}){
      try{
        diag.textContent = "";
        loadBtn.setAttribute("disabled","true");
        forceBtn.setAttribute("disabled","true");

        if(backoffMs > 0 && !options.force){
          diag.textContent = "Backoff активний: чекати " + Math.round(backoffMs/1000) + " c";
          await new Promise(r=>setTimeout(r, backoffMs));
        }

        const resp = await fetchFromWorker(channel);
        let items = [];
        if(Array.isArray(resp?.items)) items = resp.items;
        else if(Array.isArray(resp?.data?.items)) items = resp.data.items;
        else if(Array.isArray(resp)) items = resp;
        else if(Array.isArray(resp?.data)) items = resp.data;

        const normalized = (items||[]).map(it => {
          const id = it.id || it.link || it.url || it.guid || (it.link?it.link:JSON.stringify(it)).slice(0,200);
          const link = it.url || it.link || it.guid || "";
          const title = it.title || "";
          const description = (it.content_html || it.description || it.content || "").replace(/<\/?[^>]+(>|$)/g,"").trim();
          const pubDate = it.date_published || it.pubDate || it.isoDate || it.pubdate || "";
          const ts = parseDateToMillis(pubDate);
          const dateKyiv = ts ? getKyivDateString(ts) : (pubDate ? getKyivDateString(Date.now()) : "");
          return { id, link, title, description, pubDate, ts, dateKyiv };
        });

        const todayKyiv = getKyivDateString(Date.now());
        const onlyToday = normalized.filter(p => p.dateKyiv === todayKyiv && (p.ts || 0) > 0);
        onlyToday.sort((a,b)=> (b.ts || 0) - (a.ts || 0));

        if(onlyToday.length > 0){
          const saved = loadLastPosts() || [];
          const savedIds = new Set((saved||[]).map(p=>p.id||p.link));
          const newPosts = [];
          for(const p of onlyToday){
            const key = p.id || p.link || (p.title + p.pubDate);
            if(!savedIds.has(key)) newPosts.push(p);
          }

          if(newPosts.length>0){
            renderAndAnimateDiff(onlyToday, newPosts, channel);
            saveLastPosts(onlyToday);
          } else {
            renderAll(onlyToday, channel, false);
            saveLastPosts(onlyToday);
          }

          setChannelStatus(true, "відкритий");
          backoffMs = 0; consecutiveEmpty = 0; localStorage.removeItem("backoffMs"); localStorage.removeItem("consecutiveEmpty");
        } else {
          consecutiveEmpty = (parseInt(localStorage.getItem("consecutiveEmpty")||"0",10)||0) + 1;
          localStorage.setItem("consecutiveEmpty", String(consecutiveEmpty));
          const saved = loadLastPosts() || [];
          const filterSavedToday = (saved||[]).filter(p => p.dateKyiv === todayKyiv);
          if(filterSavedToday.length>0){
            renderAll(filterSavedToday, channel, true);
            setChannelStatus(false, "тимчасово недоступний", true);
            diag.textContent = "Немає постів за сьогодні; показано останні відомі пости сьогодні. Порожніх відповідей поспіль: " + consecutiveEmpty;
            if(consecutiveEmpty >= EMPTY_THRESHOLD) setChannelStatus(false, "закритий", false);
          } else {
            out.innerHTML = "<div style='padding:12px; border-radius:10px; background:#fff7ed; color:#92400e'>Сьогодні постів немає.</div>";
            setChannelStatus(false, "закритий", false);
            diag.textContent = "За сьогодні постів не знайдено.";
          }
          backoffMs = backoffMs ? Math.min(backoffMs*2, MAX_BACKOFF_MS) : 5000;
          localStorage.setItem("backoffMs", String(backoffMs));
        }
      }catch(e){
        backoffMs = backoffMs ? Math.min(backoffMs*2, MAX_BACKOFF_MS) : 5000;
        localStorage.setItem("backoffMs", String(backoffMs));
        setChannelStatus(false, "недоступний", true);
        const todayKyiv = getKyivDateString(Date.now());
        const saved = loadLastPosts() || [];
        const filterSavedToday = (saved||[]).filter(p => p.dateKyiv === todayKyiv);
        if(filterSavedToday.length>0){
          renderAll(filterSavedToday, normalizeChannelInput(channelInput.value||""), true);
          diag.textContent = "Помилка: " + String(e) + " — показано збережені (сьогодні). Backoff: " + Math.round(backoffMs/1000) + " c";
        } else {
          out.innerHTML = '<div style="padding:12px; border-radius:10px; background:#fff0f0; color:var(--danger)">Не вдалося завантажити дані. Помилка: '+String(e)+'</div>';
          diag.textContent = String(e);
        }
      } finally {
        loadBtn.removeAttribute("disabled");
        forceBtn.removeAttribute("disabled");
        document.getElementById("updated").textContent = nowStr();
      }
    }

    function renderAll(posts, channel, isStale){
      const groups = {};
      const allOblastsFound = new Set();
      const cityCounts = {};
      for(const p of posts){
        const text = (p.title || "") + " " + (p.description || "");
        const oblasts = extractOblastsFromText(text);
        for(const o of oblasts) allOblastsFound.add(o);
        const cities = extractCitiesFromText(text);
        for(const c of cities) cityCounts[c] = (cityCounts[c]||0) + 1;
        if(oblasts.length===0){
          if(!groups["Інші"]) groups["Інші"] = [];
          groups["Інші"].push(p);
        } else {
          for(const o of oblasts){ if(!groups[o]) groups[o]=[]; groups[o].push(p); }
        }
      }

      out.innerHTML = "";
      const oblastKeys = Object.keys(groups).sort((a,b)=>a.localeCompare(b,"uk"));
      for(const oblast of oblastKeys){
        const card = document.createElement("section");
        card.className = "region-card";
        const header = document.createElement("div");
        header.className = "region-header";
        header.innerHTML = '<div class="region-title">'+oblast+'</div><div class="region-meta">згадок: <strong>'+groups[oblast].length+'</strong></div>';
        card.appendChild(header);
        for(const p of groups[oblast]){
          const node = makePostNode(p, channel);
          card.appendChild(node);
        }
        out.appendChild(card);
      }

      const oblastsCount = allOblastsFound.size;
      oblastsCountEl.textContent = String(oblastsCount);

      const cityKeys = Object.keys(cityCounts).sort((a,b)=>cityCounts[b]-cityCounts[a]);
      citiesCountEl.textContent = String(cityKeys.length);
      if(cityKeys.length>0){
        citiesListEl.innerHTML = cityKeys.slice(0,10).map(k=>k + " ("+cityCounts[k]+")").join(", ");
      } else {
        citiesListEl.innerHTML = "";
      }

      if(showRawAlways.checked) renderRaw(posts); else rawBlock.style.display = "none";
    }

    function makePostNode(p, channel){
      const div = document.createElement("article");
      div.className = "post";
      div.dataset.id = p.id || p.link || (p.title + p.pubDate);
      const top = document.createElement("div"); top.className = "top";
      const title = document.createElement("div"); title.className = "title"; title.textContent = p.title || (p.description ? p.description.slice(0,140) : "(без заголовка)");
      const time = document.createElement("div"); time.className = "time"; time.textContent = formatKyiv(p.pubDate || p.ts || "");
      top.appendChild(title); top.appendChild(time);
      div.appendChild(top);
      const body = document.createElement("div"); body.className = "body"; body.textContent = p.description || "";
      div.appendChild(body);
      const actions = document.createElement("div"); actions.className = "actions";
      const open = document.createElement("a"); open.className = "open"; open.href = p.link || ("https://t.me/" + encodeURIComponent(channel)); open.target="_blank"; open.rel="noopener noreferrer"; open.textContent = "Відкрити в Telegram";
      actions.appendChild(open);
      div.appendChild(actions);
      return div;
    }

    function renderRaw(posts){
      rawBlock.style.display = "block";
      rawBlock.innerHTML = "<strong>Сирі останні пости (сьогодні)</strong>";
      if(posts.length===0){ rawBlock.innerHTML += "<div style='margin-top:8px;'>Немає постів.</div>"; return; }
      for(const p of posts){
        const wrap = document.createElement("div");
        wrap.style.marginTop = "8px";
        wrap.style.padding = "8px";
        wrap.style.borderRadius = "8px";
        wrap.style.background = "rgba(0,0,0,0.02)";
        const title = document.createElement("div"); title.style.fontWeight="700"; title.textContent = p.title || "";
        const when = document.createElement("div"); when.style.fontSize="13px"; when.style.color="var(--muted-text)"; when.textContent = formatKyiv(p.pubDate||p.ts||"");
        const pre = document.createElement("pre"); pre.style.whiteSpace="pre-wrap"; pre.textContent = p.description || "";
        const link = document.createElement("a"); link.href = p.link || ("https://t.me/" + encodeURIComponent(normalizeChannelInput(channelInput.value||""))); link.target="_blank"; link.rel="noopener noreferrer"; link.textContent = "Відкрити в Telegram"; link.style.display="inline-block"; link.style.marginTop="8px"; link.className="open";
        wrap.appendChild(title); wrap.appendChild(when); wrap.appendChild(pre); wrap.appendChild(link);
        rawBlock.appendChild(wrap);
      }
    }

    function renderAndAnimateDiff(allPosts, newPosts, channel){
      renderAll(allPosts, channel, false);
      if(newPosts.length===0) return;
      setTimeout(()=>{
        const ids = new Set(newPosts.map(p=>p.id||p.link||(p.title+p.pubDate)));
        const nodes = out.querySelectorAll("[data-id]");
        let firstSeen = null;
        for(const n of nodes){
          const nid = n.dataset.id;
          if(ids.has(nid)){
            n.classList.add("new");
            const pill = document.createElement("span"); pill.className="pill-new"; pill.textContent="НОВЕ"; pill.style.marginLeft="8px";
            const titleEl = n.querySelector(".title");
            if(titleEl && !titleEl.querySelector(".pill-new")) titleEl.appendChild(pill);
            setTimeout(()=>{ n.classList.remove("new"); const p = titleEl.querySelector(".pill-new"); if(p) p.remove(); }, 7000);
            if(!firstSeen) firstSeen = n;
          }
        }
        if(firstSeen) firstSeen.scrollIntoView({behavior:"smooth", block:"start"});
      }, 120);
    }

    loadBtn.addEventListener("click", ()=> {
      const raw = channelInput.value.trim();
      if(!raw) return alert("Вкажіть канал або ID.");
      const channel = normalizeChannelInput(raw);
      localStorage.setItem("lastChannel", channel);
      startPolling(channel);
    });
    forceBtn.addEventListener("click", ()=> {
      const raw = channelInput.value.trim();
      if(!raw) return;
      backoffMs = 0; localStorage.removeItem("backoffMs");
      analyze(normalizeChannelInput(raw), {force:true});
    });
    resetBackoffBtn.addEventListener("click", ()=> {
      backoffMs = 0; consecutiveEmpty = 0; localStorage.removeItem("backoffMs"); localStorage.removeItem("consecutiveEmpty");
      diag.textContent = "Backoff скинуто вручну.";
      const raw = channelInput.value.trim();
      if(raw) analyze(normalizeChannelInput(raw), {force:true});
    });

    function startPolling(channel){
      if(POLL_TIMER) clearInterval(POLL_TIMER);
      const sec = Math.max(10, parseInt(intervalInput.value,10) || 30);
      const effective = Math.max(sec*1000, backoffMs || 0);
      POLL_TIMER = setInterval(()=>analyze(channel).catch(()=>{}), effective);
      analyze(channel).catch(()=>{});
    }

    document.addEventListener("DOMContentLoaded", ()=>{
      const lastFetched = localStorage.getItem("lastFetchedAt");
      if(lastFetched){
        const savedDay = getKyivDateString(new Date(lastFetched).getTime());
        const today = getKyivDateString(Date.now());
        if(savedDay !== today){
          localStorage.removeItem("lastPosts");
          localStorage.removeItem("lastFetchedAt");
        }
      }
      const saved = localStorage.getItem("lastChannel");
      if(saved) channelInput.value = saved;
      const initial = normalizeChannelInput(channelInput.value||"kpszsu");
      if(initial) startPolling(initial);
    });
  </script>
</body>
</html>

<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Telegram — Повітряні тривоги</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="color-scheme" content="dark light" />
  <style>
    :root{
      --accent:#2563eb;
      --success:#10b981;
      --danger:#ef4444;
      --muted:#6b7280;
      --input-bg:#0f1724;
      --input-text:#f8fafc;
      --input-placeholder:#94a3b8;
      --card-bg:#ffffff;
    }
    body{font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin:0; padding:0; background: #f8fafc; color: #0f1724;}
    .btn{ position:relative; display:inline-flex; align-items:center; gap:.5rem; padding:.5rem .75rem; border-radius:.5rem; background:var(--accent); color:white; font-weight:600; cursor:pointer; user-select:none; overflow:hidden; transform:translateZ(0); transition:transform .12s ease, box-shadow .12s ease, opacity .12s ease; box-shadow: 0 6px 18px rgba(37,99,235,0.12); }
    .btn.secondary{ background:#374151; box-shadow: 0 6px 18px rgba(15,23,42,0.08); }
    .btn.ghost{ background:transparent; color:var(--accent); border:1px solid rgba(37,99,235,0.12); box-shadow:none; }
    .btn[disabled]{ opacity:.6; pointer-events:none; transform:none; box-shadow:none; }

    .ripple{ position:absolute; border-radius:999px; transform:scale(0); background:rgba(255,255,255,0.25); animation:ripple .6s linear; pointer-events:none; z-index:1; }
    @keyframes ripple{ to { transform: scale(4); opacity: 0; } }

    .badge{ display:inline-flex; align-items:center; gap:.5rem; padding:.25rem .5rem; border-radius:999px; font-weight:600; font-size:13px; }
    .badge.open{ background: rgba(16,185,129,0.08); color: var(--success); border:1px solid rgba(16,185,129,0.12); }
    .badge.closed{ background: rgba(239,68,68,0.06); color: var(--danger); border:1px solid rgba(239,68,68,0.08); }
    .badge.unknown{ background: rgba(148,163,184,0.06); color: var(--muted); border:1px solid rgba(148,163,184,0.06); }

    .status-flash{ animation: flash 1200ms ease-in-out; box-shadow: 0 0 0 3px rgba(99,102,241,0.12), 0 6px 18px rgba(99,102,241,0.08); }
    @keyframes flash{ 0%{ box-shadow: 0 0 0 0 rgba(99,102,241,0.18); } 40%{ box-shadow: 0 0 8px 6px rgba(99,102,241,0.12); } 100%{ box-shadow: none; } }

    .spinner{ width:16px; height:16px; border-radius:50%; border:2px solid rgba(255,255,255,0.25); border-top-color:rgba(255,255,255,0.9); animation:spin .8s linear infinite; }
    .spinner.small{ width:12px; height:12px; border-width:2px; border-top-color:rgba(0,0,0,0.7); border-bottom-color:rgba(0,0,0,0.08); }
    @keyframes spin{ to { transform: rotate(360deg); } }

    input[type="text"], input[type="number"], select, .input-like { border-radius:.5rem; padding:.5rem .6rem; border:1px solid rgba(255,255,255,0.06); outline:none; background:var(--input-bg); color:var(--input-text); transition:box-shadow .12s ease, border-color .12s ease; }
    input::placeholder{ color: var(--input-placeholder); opacity:1; }
    input:focus, select:focus{ box-shadow: 0 6px 18px rgba(37,99,235,0.08); border-color: rgba(99,102,241,0.5); }

    .card{ background:var(--card-bg); }
    .small{ font-size:13px; }
    .live-announcer{ position:absolute; left:-9999px; top:auto; width:1px; height:1px; overflow:hidden; }

    pre{ white-space:pre-wrap; word-break:break-word; font-family:inherit; font-size:13px; color:inherit; }

    @media (prefers-color-scheme: dark){
      :root{ --card-bg: #0b1220; --input-bg:#0b1220; --input-text:#eef2ff; --input-placeholder:#94a3b8; }
      body{ background:#05060a; color:#e6eef8; }
    }

    .container { max-width:1100px; margin:24px auto; padding:16px; }
    .controls { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .controls .left { display:flex; gap:8px; align-items:center; }
    .controls .right { margin-left:auto; display:flex; gap:8px; align-items:center; }
    .card-block { border-radius:12px; padding:14px; background:var(--card-bg); box-shadow: 0 2px 10px rgba(2,6,23,0.04); }
  </style>
</head>
<body>
  <div class="container">
    <header style="display:flex; align-items:flex-end; gap:12px; margin-bottom:14px;">
      <div>
        <h1 style="margin:0; font-size:20px; font-weight:700;">Telegram — Перегляд каналів (повітряні тривоги)</h1>
        <div style="font-size:13px; color:var(--muted); margin-top:6px;">Дані через RSSHub і ваш Cloudflare Worker</div>
      </div>
      <div style="margin-left:auto; text-align:right; font-size:12px; color:var(--muted);">
        Оновлено: <span id="updated" class="mono">—</span><br />
        Worker: <span id="workerUrl" style="font-weight:600; color:var(--accent)">dawn-bird-9d4d.nevaznoa855.workers.dev</span>
      </div>
    </header>

    <section class="card-block">
      <div class="controls">
        <div class="left">
          <label style="font-size:13px; color:var(--muted);">Канал / посилання / ID</label>
          <input id="channelInput" type="text" style="width:360px" value="kpszsu" placeholder="kpszsu або https://t.me/kpszsu або 123456789" />
          <button id="loadBtn" class="btn">Завантажити</button>
          <button id="forceBtn" class="btn secondary">Примусово оновити</button>
          <button id="resetBackoffBtn" class="btn ghost">Скинути backoff</button>
        </div>

        <div class="right">
          <label style="font-size:13px; color:var(--muted);">Постів:</label>
          <select id="countSelect" style="padding:6px 8px; border-radius:8px;">
            <option value="10">10</option>
            <option value="20" selected>20</option>
            <option value="30">30</option>
            <option value="50">50</option>
          </select>

          <label style="font-size:13px; color:var(--muted);">Інтервал, сек:</label>
          <input id="intervalInput" type="number" min="10" value="30" style="width:70px; padding:6px 8px; border-radius:8px;" />

          <label style="font-size:13px; color:var(--muted); display:flex; align-items:center; gap:6px;">
            <input id="showRawAlways" type="checkbox" checked />
            Показувати сирі пости
          </label>
        </div>
      </div>

      <div style="margin-top:12px; display:flex; gap:12px; align-items:center;">
        <div id="channelBadge" class="badge unknown">Статус: <span id="statusText" style="margin-left:8px">—</span></div>
        <div id="diag" style="color:var(--danger); font-size:13px"></div>
      </div>
    </section>

    <div id="summary" style="margin-top:12px"></div>
    <div id="out" style="margin-top:12px"></div>

    <div class="live-announcer" aria-live="polite" id="announcer"></div>

    <footer style="margin-top:18px; color:var(--muted); font-size:13px;">Порада: при проблемах натисніть Скинути backoff або Примусово оновити</footer>
  </div>

  <script>
    const WORKER_BASE = "https://dawn-bird-9d4d.nevaznoa855.workers.dev/?channel=";
    const WORKER_HOST = "dawn-bird-9d4d.nevaznoa855.workers.dev";
    const KYIV_TZ = "Europe/Kyiv";

    const EMPTY_THRESHOLD = 2;
    const MAX_BACKOFF_MS = 300000;
    const INITIAL_POLL_MS = 30000;

    let POLL_MS = INITIAL_POLL_MS;
    let POLL_TIMER = null;
    let consecutiveEmpty = parseInt(localStorage.getItem("consecutiveEmpty")||"0",10);
    let backoffMs = parseInt(localStorage.getItem("backoffMs")||"0",10) || 0;

    const loadBtn = document.getElementById("loadBtn");
    const forceBtn = document.getElementById("forceBtn");
    const resetBackoffBtn = document.getElementById("resetBackoffBtn");
    const channelInput = document.getElementById("channelInput");
    const statusText = document.getElementById("statusText");
    const channelBadge = document.getElementById("channelBadge");
    const announcer = document.getElementById("announcer");
    const diag = document.getElementById("diag");
    document.getElementById("workerUrl").textContent = WORKER_HOST;

    function nowStr(){ try { return new Date().toLocaleString("uk-UA",{timeZone:KYIV_TZ,hour12:false}); } catch { return new Date().toString(); } }

    function normalizeChannelInput(raw){
      if(!raw) return "";
      raw = raw.trim();
      if(raw.startsWith("@")) raw = raw.slice(1);
      try{
        const u = new URL(raw);
        const p = u.pathname.replace(/^\/+|\/+$/g,"");
        if(p.length>0){
          return p.split("/")[0];
        }
        return raw;
      }catch(e){
        return raw;
      }
    }

    function buildWorkerUrl(channel, extra){
      const e = extra ? "&" + extra.replace(/^[&?]+/,"") : "";
      return WORKER_BASE + encodeURIComponent(channel) + e;
    }

    async function fetchFromWorker(channel, extra){
      const url = buildWorkerUrl(channel, extra);
      const r = await fetch(url, { cache: "no-store" });
      if(!r.ok){
        const txt = await r.text().catch(()=>"" );
        throw new Error("HTTP "+r.status + " " + txt.slice(0,400));
      }
      return r.json();
    }

    function setChannelStatus(open, text, silent=false){
      const prev = localStorage.getItem("lastStatus") || "unknown";
      if(open){
        channelBadge.classList.remove("closed","unknown");
        channelBadge.classList.add("open");
        statusText.textContent = text || "відкритий";
        announcer.textContent = "Канал відкритий";
        localStorage.setItem("lastStatus","open");
      } else {
        channelBadge.classList.remove("open","unknown");
        channelBadge.classList.add("closed");
        statusText.textContent = text || "закритий";
        announcer.textContent = "Канал закритий або недоступний для RSSHub";
        localStorage.setItem("lastStatus","closed");
      }
      if(!silent && prev !== localStorage.getItem("lastStatus")){
        channelBadge.classList.add("status-flash");
        setTimeout(()=>channelBadge.classList.remove("status-flash"),1400);
      }
    }

    function saveSuccessfulPosts(posts){
      try{
        localStorage.setItem("lastPosts", JSON.stringify(posts));
        localStorage.setItem("lastFetchedAt", new Date().toISOString());
        localStorage.setItem("consecutiveEmpty", "0");
        consecutiveEmpty = 0;
      }catch(e){}
    }

    function loadSavedPosts(){
      try{
        const raw = localStorage.getItem("lastPosts");
        if(!raw) return null;
        return JSON.parse(raw);
      }catch{return null}
    }

    function getSavedFetchedAt(){
      return localStorage.getItem("lastFetchedAt") || null;
    }

    function increaseBackoff(){
      backoffMs = backoffMs ? Math.min(backoffMs*2, MAX_BACKOFF_MS) : 5000;
      localStorage.setItem("backoffMs", String(backoffMs));
    }

    function resetBackoff(){
      backoffMs = 0;
      consecutiveEmpty = 0;
      localStorage.removeItem("backoffMs");
      localStorage.removeItem("consecutiveEmpty");
    }

    function getStaleAge(){
      const at = getSavedFetchedAt();
      if(!at) return null;
      const d = new Date(at);
      const diff = Math.floor((Date.now() - d.getTime())/1000);
      if(diff < 60) return diff + " c";
      if(diff < 3600) return Math.floor(diff/60) + " хв";
      return Math.floor(diff/3600) + " год";
    }

    function renderResults(groups, posts, channel, isStale=false){
      const out = document.getElementById("out");
      out.innerHTML = "";
      const summary = document.getElementById("summary");
      const regionsCount = Object.keys(groups).length;
      const staleLabel = isStale ? (' <span style="color:#b45309; font-size:12px">(застаріло: '+(getStaleAge()||"невідомо")+")</span>") : "";
      summary.innerHTML = '<div style="display:flex; gap:10px; align-items:center;"><div style="display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; background:#fee2e2; color:#b91c1c"><span style="width:10px;height:10px;border-radius:999px;background:#ef4444;display:inline-block"></span>Областей згадано: <strong style="margin-left:6px">'+regionsCount+'</strong></div><div style="color:var(--muted); font-size:13px;">Постів проаналізовано: <strong>'+posts.length+'</strong>'+staleLabel+'</div></div>';

      if(Object.keys(groups).length>0){
        for(const oblast of Object.keys(groups).sort((a,b)=>a.localeCompare(b,"uk"))){
          const block = document.createElement("section");
          block.style.borderRadius = "12px";
          block.style.padding = "12px";
          block.style.background = "var(--card-bg)";
          block.style.marginTop = "10px";
          const header = document.createElement("div");
          header.style.display = "flex";
          header.style.justifyContent = "space-between";
          header.innerHTML = '<h2 style="margin:0; font-weight:700">'+oblast+'</h2><div style="color:var(--muted); font-size:13px">знайдено згадок: <strong>'+groups[oblast].length+'</strong></div>';
          block.appendChild(header);
          const list = document.createElement("ul");
          list.style.marginTop = "8px";
          list.style.listStyle = "none";
          for(const item of groups[oblast]){
            const li = document.createElement("li");
            li.style.padding = "10px";
            li.style.borderRadius = "8px";
            li.style.background = "#f8fafc";
            li.style.marginBottom = "8px";
            const titleRow = document.createElement("div");
            titleRow.style.display = "flex";
            titleRow.style.justifyContent = "space-between";
            titleRow.innerHTML = '<div style="font-weight:600">'+(item.title||"")+'</div><div style="color:var(--muted); font-size:13px">'+new Date(item.pubDate).toLocaleString("uk-UA",{timeZone:KYIV_TZ,hour12:false})+'</div>';
            li.appendChild(titleRow);
            const pre = document.createElement("div");
            pre.style.marginTop = "6px";
            pre.style.fontSize = "14px";
            pre.style.color = "#0f1724";
            pre.innerText = (item.description||"").replace(/<\/?[^>]+(>|$)/g,"");
            li.appendChild(pre);
            const openBtn = document.createElement("a");
            openBtn.className = "btn ghost";
            openBtn.style.display = "inline-block";
            openBtn.style.marginTop = "8px";
            openBtn.href = item.link || ("https://t.me/"+encodeURIComponent(channel));
            openBtn.target = "_blank";
            openBtn.rel = "noopener noreferrer";
            openBtn.innerText = "Відкрити в Telegram";
            li.appendChild(openBtn);
            list.appendChild(li);
          }
          block.appendChild(list);
          out.appendChild(block);
        }
      }

      const rawBlock = document.createElement("section");
      rawBlock.style.borderRadius = "12px";
      rawBlock.style.padding = "12px";
      rawBlock.style.background = "var(--card-bg)";
      rawBlock.style.marginTop = "12px";
      rawBlock.innerHTML = "<strong>Сирі останні пости</strong>";
      if(posts.length===0){
        rawBlock.innerHTML += '<div style="margin-top:10px; padding:10px; border-radius:8px; background:#f8fafc; color:var(--muted)">Немає доступних постів або канал не публічний / заблокований для RSSHub.</div>';
      } else {
        for(const p of posts){
          const pdiv = document.createElement("div");
          pdiv.style.marginTop = "10px";
          pdiv.style.padding = "10px";
          pdiv.style.borderRadius = "8px";
          pdiv.style.background = "#f8fafc";
          const titleRow = document.createElement("div");
          titleRow.style.display = "flex";
          titleRow.style.justifyContent = "space-between";
          titleRow.innerHTML = '<div style="font-weight:600">'+(p.title||"")+'</div><div style="color:var(--muted); font-size:13px">'+new Date(p.pubDate).toLocaleString("uk-UA",{timeZone:KYIV_TZ,hour12:false})+'</div>';
          pdiv.appendChild(titleRow);
          const pre = document.createElement("pre");
          pre.style.marginTop = "8px";
          pre.innerText = (p.description||"").replace(/<\/?[^>]+(>|$)/g,"");
          pdiv.appendChild(pre);
          const openBtn = document.createElement("a");
          openBtn.className = "btn ghost";
          openBtn.style.display = "inline-block";
          openBtn.style.marginTop = "8px";
          openBtn.href = p.link || ("https://t.me/"+encodeURIComponent(channel));
          openBtn.target = "_blank";
          openBtn.rel = "noopener noreferrer";
          openBtn.innerText = "Відкрити в Telegram";
          pdiv.appendChild(openBtn);
          rawBlock.appendChild(pdiv);
        }
      }
      out.appendChild(rawBlock);
      document.getElementById("updated").textContent = nowStr();
    }

    async function analyze(channel, options = {force:false}) {
      try {
        setChannelStatus(false, "перевіряємо...", true);
        loadBtn.setAttribute("disabled","true");
        forceBtn.setAttribute("disabled","true");
        resetBackoffBtn.setAttribute("disabled","true");
        diag.textContent = "";

        if(backoffMs > 0 && !options.force) {
          diag.textContent = "Backoff активний: чекати " + Math.round(backoffMs/1000) + " c";
          await new Promise(r=>setTimeout(r, backoffMs));
        }

        const start = Date.now();
        const data = await fetchFromWorker(channel);
        const took = Date.now() - start;
        let items = [];

        if(Array.isArray(data?.items)) {
          items = data.items;
        } else if(Array.isArray(data?.data?.items)) {
          items = data.data.items;
        } else if(Array.isArray(data)) {
          items = data;
        } else if(Array.isArray(data?.rss?.channel?.item)) {
          items = data.rss.channel.item;
        }

        const maxPosts = parseInt(document.getElementById("countSelect").value,10) || 20;

        if(items && items.length > 0) {
          const posts = items.slice(0, maxPosts).map(it => ({ title: it.title||"", description: it.description||it.content_html||it.content||"", pubDate: it.date_published||it.pubDate||it.isoDate||new Date().toISOString(), link: it.url || it.link || it.guid || "" }));
          saveSuccessfulPosts(posts);
          resetBackoff();
          consecutiveEmpty = 0;
          localStorage.setItem("consecutiveEmpty", "0");
          setChannelStatus(true, "відкритий");
          const groups = {};
          for(const p of posts){
            const text = (p.title||"")+" "+(p.description||"");
            const O = ["Вінницька","Волинська","Дніпропетровська","Донецька","Житомирська","Закарпатська","Запорізька","Івано-Франківська","Київська","Кіровоградська","Луганська","Львівська","Миколаївська","Одеська","Полтавська","Рівненська","Сумська","Тернопільська","Харківська","Херсонська","Хмельницька","Черкаська","Чернівецька","Чернігівська","м. Київ","м. Севастополь"];
            const found = new Set();
            for(const o of O){
              const re = new RegExp("\\b"+o.replace(/[.*+?^${}()|[\\]\\\\]/g,"\\\\$&")+"\\b","iu");
              if(re.test(text)) found.add(o);
            }
            const oblasts = Array.from(found);
            for(const o of oblasts){ if(!groups[o]) groups[o]=[]; groups[o].push(p); }
          }
          renderResults(groups, posts, channel, false);
          diag.textContent = "Оновлено за "+Math.round(took/10)/100+" c";
        } else {
          consecutiveEmpty = (parseInt(localStorage.getItem("consecutiveEmpty")||"0",10) || 0) + 1;
          localStorage.setItem("consecutiveEmpty", String(consecutiveEmpty));
          const savedPosts = loadSavedPosts();
          if(savedPosts && savedPosts.length>0){
            setChannelStatus(false, "тимчасово недоступний", true);
            const groups = {};
            for(const p of savedPosts){
              const text = (p.title||"")+" "+(p.description||"");
              const O = ["Вінницька","Волинська","Дніпропетровська","Донецька","Житомирська","Закарпатська","Запорізька","Івано-Франківська","Київська","Кіровоградська","Луганська","Львівська","Миколаївська","Одеська","Полтавська","Рівненська","Сумська","Тернопільська","Харківська","Херсонська","Хмельницька","Черкаська","Чернівецька","Чернігівська","м. Київ","м. Севастополь"];
              const found = new Set();
              for(const o of O){
                const re = new RegExp("\\b"+o.replace(/[.*+?^${}()|[\\]\\\\]/g,"\\\\$&")+"\\b","iu");
                if(re.test(text)) found.add(o);
              }
              const oblasts = Array.from(found);
              for(const o of oblasts){ if(!groups[o]) groups[o]=[]; groups[o].push(p); }
            }
            renderResults(groups, savedPosts, channel, true);
            diag.textContent = "Отримано порожню відповідь від RSSHub. Показуються останні відомі пости. Порожніх відповідей поспіль: " + consecutiveEmpty;
            if(consecutiveEmpty >= EMPTY_THRESHOLD){
              setChannelStatus(false, "закритий", false);
            }
          } else {
            setChannelStatus(false, "закритий", false);
            renderResults({}, [], channel, false);
            diag.textContent = "Канал не повернув пости і збережених постів немає. Порожніх відповідей поспіль: " + consecutiveEmpty;
          }
          increaseBackoff();
        }
      } catch(e) {
        increaseBackoff();
        setChannelStatus(false, "недоступний", true);
        const savedPosts = loadSavedPosts() || [];
        if(savedPosts.length>0){
          renderResults({}, savedPosts, normalizeChannelInput(channelInput.value||""), true);
          diag.textContent = "Помилка мережі/серверу: " + String(e) + ". Показуються збережені пости. Backoff: " + Math.round(backoffMs/1000) + " c";
        } else {
          document.getElementById("out").innerHTML = '<div style="padding:12px; border-radius:8px; background:#fee2e2; color:#b91c1c">Не вдалося завантажити дані. Помилка: '+String(e)+'</div>';
          diag.textContent = String(e);
        }
      } finally {
        loadBtn.removeAttribute("disabled");
        forceBtn.removeAttribute("disabled");
        resetBackoffBtn.removeAttribute("disabled");
      }
    }

    function startPolling(channel){
      if(POLL_TIMER) clearInterval(POLL_TIMER);
      const sec = Math.max(10, parseInt(document.getElementById("intervalInput").value,10) || 30);
      POLL_MS = sec * 1000;
      const effectiveInterval = Math.max(POLL_MS, backoffMs || 0) || POLL_MS;
      POLL_TIMER = setInterval(()=>analyze(channel).catch(()=>{}), effectiveInterval);
      analyze(channel).catch(()=>{});
      document.getElementById("intervalInput").value = sec;
    }

    loadBtn.addEventListener("click", function(ev){
      const raw = channelInput.value.trim();
      if(!raw) return alert("Вкажіть канал або ID (наприклад kpszsu або https://t.me/kpszsu).");
      const channel = normalizeChannelInput(raw);
      localStorage.setItem("lastChannel", channel);
      startPolling(channel);
    });

    forceBtn.addEventListener("click", function(ev){
      const raw = channelInput.value.trim();
      if(!raw) return;
      const channel = normalizeChannelInput(raw);
      backoffMs = 0;
      localStorage.removeItem("backoffMs");
      analyze(channel, {force:true}).catch(()=>{});
    });

    resetBackoffBtn.addEventListener("click", function(){
      resetBackoff();
      diag.textContent = "Backoff скинуто вручну.";
      const channel = normalizeChannelInput(channelInput.value||"");
      if(channel) analyze(channel, {force:true}).catch(()=>{});
    });

    document.addEventListener("DOMContentLoaded", function(){
      const saved = localStorage.getItem("lastChannel");
      if(saved) channelInput.value = saved;
      const initial = normalizeChannelInput(channelInput.value||"kpszsu");
      if(initial) startPolling(initial);
    });

    window.addEventListener("beforeunload", function(){
      try{ localStorage.setItem("lastChannel", normalizeChannelInput(channelInput.value||"")); }catch(e){}
    });
  </script>
</body>
</html>
